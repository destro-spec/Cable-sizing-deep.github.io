<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cable Current Rating Calculator</title>
    <script>
        // Fallback cableData in case the external file fails to load
        if (typeof cableData === 'undefined') {
            console.log("Creating fallback cableData object");
            window.cableData = {
                // Essential conductor sizes for dropdown functionality
                conductorSizes: {
                    singleCore: [25, 35, 50, 70, 95, 120, 150, 185, 240, 300, 400, 500, 630, 800, 1000],
                    threeCore: [25, 35, 50, 70, 95, 120, 150, 185, 240, 300, 400, 500]
                },
                // Basic current ratings
                // Table-1: Single-Core Copper cable with XLPE insulation
                singleCoreCopper: {
                    "1.9/3.3kV-3.8/6.6kV": {
                        buriedDirect: {
                            trefoil: [127, 151, 178, 216, 256, 290, 323, 362, 411, 456, 508, 559, 611, 638, 672],
                            flatTouching: [130, 155, 181, 220, 260, 292, 323, 359, 398, 435, 474, 509, 543, 549, 569]
                        },
                        inDucts: {
                            trefoil: [113, 135, 158, 192, 227, 257, 285, 319, 361, 400, 443, 486, 529, 549, 575],
                            flatTouching: [111, 132, 154, 187, 220, 247, 272, 302, 333, 363, 393, 420, 446, 447, 460]
                        },
                        inAir: {
                            trefoil: [148, 179, 214, 267, 323, 374, 422, 484, 565, 641, 734, 828, 929, 1002, 1083],
                            flatTouching: [151, 183, 218, 271, 327, 376, 422, 481, 550, 615, 690, 761, 834, 872, 927]
                        }
                    },
                    // Table-3: Single-Core Copper cablewith XLPE insulation
                    "6.6/6.6kV-11/11kV": {
                        buriedDirect: {
                            trefoil: [127, 151, 178, 216, 257, 290, 323, 360, 411, 456, 508, 559, 611, 639, 672],
                            flatTouching: [130, 155, 181, 220, 259, 292, 323, 354, 398, 435, 474, 510, 544, 550, 569]
                        },
                        inDucts: {
                            trefoil: [113, 134, 157, 191, 227, 256, 285, 317, 361, 399, 443, 486, 529, 550, 575],
                            flatTouching: [111, 132, 154, 186, 219, 246, 272, 297, 332, 363, 392, 420, 446, 448, 460]
                        },
                        inAir: {
                            trefoil: [150, 181, 216, 269, 326, 376, 424, 487, 568, 643, 733, 828, 930, 1002, 1083],
                            flatTouching: [153, 185, 219, 273, 329, 378, 425, 480, 552, 616, 690, 761, 835, 873, 927]
                        }
                    },
                    // Table-5: Single-Core Copper cable with XLPE insulation
                    "12.7/22kV-19/33kV": {
                        buriedDirect: {
                            trefoil: [150, 176, 214, 253, 285, 317, 355, 404, 442, 490, 538, 586, 629, 643],
                            flatTouching: [153, 178, 215, 253, 284, 313, 346, 387, 413, 449, 482, 513, 540, 552]
                        },
                        inDucts: {
                            trefoil: [132, 154, 187, 221, 249, 276, 308, 350, 382, 422, 462, 504, 550, 560],
                            flatTouching: [129, 150, 180, 212, 236, 260, 286, 320, 339, 367, 393, 416, 447, 453]
                        },
                        inAir: {
                            trefoil: [185, 224, 278, 336, 386, 434, 494, 575, 644, 734, 825, 920, 1014, 1074],
                            flatTouching: [188, 227, 280, 336, 384, 429, 485, 556, 611, 683, 753, 823, 890, 938]
                        }
                    }
                },
                singleCoreAluminum: {
                    "1.9/3.3kV-3.8/6.6kV": {
                        buriedDirect: {
                            trefoil: [99, 117, 138, 168, 200, 227, 252, 285, 326, 365, 412, 461, 514, 553, 595],
                            flatTouching: [101, 120, 141, 172, 204, 230, 255, 287, 323, 357, 397, 436, 476, 496, 523]
                        },
                        inDucts: {
                            trefoil: [88, 104, 123, 149, 177, 201, 223, 251, 286, 319, 359, 401, 445, 476, 509],
                            flatTouching: [87, 103, 120, 146, 172, 195, 215, 241, 270, 298, 329, 360, 390, 404, 423]
                        },
                        inAir: {
                            trefoil: [115, 139, 166, 208, 252, 292, 329, 380, 448, 511, 593, 680, 777, 863, 954],
                            flatTouching: [118, 142, 169, 212, 256, 296, 333, 383, 444, 502, 574, 647, 725, 780, 846]
                        }
                    },
                    "6.6/6.6kV-11/11kV": {
                        buriedDirect: {
                            trefoil: [99, 117, 138, 168, 200, 227, 252, 285, 326, 365, 412, 461, 514, 553, 595],
                            flatTouching: [101, 120, 141, 172, 204, 230, 255, 287, 323, 357, 397, 436, 476, 496, 523]
                        },
                        inDucts: {
                            trefoil: [88, 104, 123, 149, 177, 201, 223, 251, 286, 319, 359, 401, 445, 476, 509],
                            flatTouching: [87, 103, 120, 146, 172, 195, 215, 241, 270, 298, 329, 360, 390, 404, 423]
                        },
                        inAir: {
                            trefoil: [115, 139, 166, 208, 252, 292, 329, 380, 448, 511, 593, 680, 777, 863, 954],
                            flatTouching: [118, 142, 169, 212, 256, 296, 333, 383, 444, 502, 574, 647, 725, 780, 846]
                        }
                    },
                    "12.7/22kV-19/33kV": {
                        buriedDirect: {
                            trefoil: [99, 117, 138, 168, 200, 227, 252, 285, 326, 365, 412, 461, 514, 553, 595],
                            flatTouching: [101, 120, 141, 172, 204, 230, 255, 287, 323, 357, 397, 436, 476, 496, 523]
                        },
                        inDucts: {
                            trefoil: [88, 104, 123, 149, 177, 201, 223, 251, 286, 319, 359, 401, 445, 476, 509],
                            flatTouching: [87, 103, 120, 146, 172, 195, 215, 241, 270, 298, 329, 360, 390, 404, 423]
                        },
                        inAir: {
                            trefoil: [115, 139, 166, 208, 252, 292, 329, 380, 448, 511, 593, 680, 777, 863, 954],
                            flatTouching: [118, 142, 169, 212, 256, 296, 333, 383, 444, 502, 574, 647, 725, 780, 846]
                        }
                    }
                },
                threeCoreCopper: {
                    "1.9/3.3kV-3.8/6.6kV": {
                        buriedDirect: [121, 144, 169, 206, 246, 278, 310, 350, 401, 449, 506, 565],
                        inDucts: [104, 124, 146, 178, 212, 240, 268, 302, 353, 395, 445, 497],
                        inAir: [132, 159, 188, 234, 284, 326, 368, 422, 492, 559, 642, 730]
                    },
                    "6.6/6.6kV-11/11kV": {
                        buriedDirect: [121, 144, 169, 206, 246, 278, 310, 350, 401, 449, 506, 565],
                        inDucts: [104, 124, 146, 178, 212, 240, 268, 302, 353, 395, 445, 497],
                        inAir: [132, 159, 188, 234, 284, 326, 368, 422, 492, 559, 642, 730]
                    },
                    "12.7/22kV-19/33kV": {
                        buriedDirect: [121, 144, 169, 206, 246, 278, 310, 350, 401, 449, 506, 565],
                        inDucts: [104, 124, 146, 178, 212, 240, 268, 302, 353, 395, 445, 497],
                        inAir: [132, 159, 188, 234, 284, 326, 368, 422, 492, 559, 642, 730]
                    }
                },
                threeCoreAluminum: {
                    "1.9/3.3kV-3.8/6.6kV": {
                        buriedDirect: [94, 112, 131, 160, 191, 216, 241, 273, 315, 354, 403, 457],
                        inDucts: [81, 96, 113, 138, 165, 187, 209, 270, 277, 312, 355, 403],
                        inAir: [102, 123, 146, 182, 221, 254, 286, 330, 385, 440, 512, 590]
                    },
                    "6.6/6.6kV-11/11kV": {
                        buriedDirect: [94, 112, 131, 160, 191, 216, 241, 273, 315, 354, 403, 457],
                        inDucts: [81, 96, 113, 138, 165, 187, 209, 270, 277, 312, 355, 403],
                        inAir: [102, 123, 146, 182, 221, 254, 286, 330, 385, 440, 512, 590]
                    },
                    "12.7/22kV-19/33kV": {
                        buriedDirect: [94, 112, 131, 160, 191, 216, 241, 273, 312, 351, 400, 454],
                        inDucts: [81, 96, 113, 138, 165, 187, 209, 270, 277, 312, 355, 403],
                        inAir: [102, 123, 146, 182, 221, 254, 286, 330, 385, 440, 512, 590]
                    }
                },
                // Basic derating factors
                temperatureFactors: {
                    air: { 
                        temperatures: [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60],
                        factors: [1.14, 1.132, 1.124, 1.116, 1.108, 1.1, 1.09, 1.08, 1.07, 1.06, 1.05, 1.04, 1.03, 1.02, 1.01, 0.99, 0.98, 0.97, 0.96, 0.95, 0.384, 0.93, 0.926, 0.914, 0.902, 0.89, 0.88, 0.87, 0.86, 0.85, 0.84, 0.826, 0.812, 0.798, 0.784, 0.77]
                    },
                    ground: { 
                        temperatures: [15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50],
                        factors: [1.12, 1.112, 1.104, 1.096, 1.086, 1.08, 1.072, 1.064, 1.056, 1.048, 1.04, 1.032, 1.024, 1.016, 1.008, 1.00, 0.992, 0.984, 0.976, 0.968, 0.96, 0.95, 0.94, 0.93, 0.92, 0.91, 0.902, 0.894, 0.886, 0.878, 0.87, 0.86, 0.85, 0.84, 0.83, 0.82]
                    },
                    ducts: { 
                        temperatures: [15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50],
                        factors: [1.12, 1.112, 1.104, 1.096, 1.086, 1.08, 1.072, 1.064, 1.056, 1.048, 1.04, 1.032, 1.024, 1.016, 1.008, 1.00, 0.992, 0.984, 0.976, 0.968, 0.96, 0.95, 0.94, 0.93, 0.92, 0.91, 0.902, 0.894, 0.886, 0.878, 0.87, 0.86, 0.85, 0.84, 0.83, 0.82]
                    },
                },
                // More accurate depth factors
                depthFactors: {
                    buriedDirect: { 
                        "3.3-11kV": { 
                            depths: [900, 1050, 1200, 1500, 1800, 2000, 2500, 3000],
                            singleCore: { 
                                "≤185": [1.00, 0.99, 0.97, 0.95, 0.93, 0.92, 0.91, 0.89],
                                ">185": [1.00, 0.98, 0.96, 0.94, 0.92, 0.91, 0.89, 0.87]
                            },
                            threeCore: [1.00, 0.98, 0.97, 0.95, 0.94, 0.93, 0.91, 0.90]
                        },
                        "22-33kV": { 
                            depths: [900, 1050, 1200, 1500, 1800, 2000, 2500, 3000],
                            singleCore: { 
                                "≤185": [1.00, 0.98, 0.97, 0.95, 0.93, 0.92, 0.90, 0.89],
                                ">185": [1.00, 0.98, 0.97, 0.94, 0.92, 0.91, 0.89, 0.88]
                            },
                            threeCore: [1.00, 0.99, 0.98, 0.96, 0.95, 0.94, 0.92, 0.91]
                        }
                    },
                    inDucts: { 
                        "3.3-11kV": { 
                            depths: [900, 1050, 1200, 1500, 1800, 2000, 2500, 3000],
                            singleCore: { 
                                "≤185": [1.00, 0.98, 0.97, 0.95, 0.93, 0.92, 0.90, 0.89],
                                ">185": [1.00, 0.98, 0.97, 0.94, 0.92, 0.91, 0.89, 0.88]
                            },
                            threeCore: [1.00, 0.99, 0.98, 0.96, 0.95, 0.94, 0.92, 0.91]
                        },
                        "22-33kV": { 
                            depths: [900, 1050, 1200, 1500, 1800, 2000, 2500, 3000],
                            singleCore: { 
                                "≤185": [1.00, 0.98, 0.97, 0.95, 0.93, 0.92, 0.90, 0.89],
                                ">185": [1.00, 0.98, 0.97, 0.94, 0.92, 0.91, 0.89, 0.88]
                            },
                            threeCore: [1.00, 0.99, 0.98, 0.96, 0.95, 0.94, 0.92, 0.91]
                        }
                    }
                },
                // Improved grouping factors
                groupingFactors: {
                    singleCore: {
                        buriedDirect: { 
                            circuits: [1, 2, 3, 4, 6, 8, 10, 12],
                            spacing: ["Touching", 0.2, 0.4, 0.6, 0.8],
                            factors: [
                                [1.00, 1.00, 1.00, 1.00, 1.00],
                                [0.80, 0.85, 0.87, 0.88, 0.90],
                                [0.70, 0.77, 0.82, 0.85, 0.87],
                                [0.65, 0.73, 0.78, 0.82, 0.85],
                                [0.60, 0.68, 0.73, 0.77, 0.80],
                                [0.56, 0.64, 0.70, 0.74, 0.78],
                                [0.53, 0.62, 0.68, 0.72, 0.76],
                                [0.50, 0.60, 0.66, 0.70, 0.74]
                            ]
                        },
                        inDucts: { 
                            circuits: [1, 2, 3, 4, 6, 8], 
                            spacing: ["Touching", 0.2, 0.4, 0.6, 0.8],
                            factors: [
                                [1.00, 1.00, 1.00, 1.00, 1.00],
                                [0.85, 0.90, 0.95, 0.96, 0.97],
                                [0.75, 0.85, 0.90, 0.92, 0.94],
                                [0.70, 0.80, 0.85, 0.88, 0.90],
                                [0.60, 0.75, 0.80, 0.84, 0.86],
                                [0.57, 0.70, 0.76, 0.80, 0.83]
                            ]
                        },
                        inAirTrefoil: { 
                            trays: [1, 2, 3], 
                            circuits: [1, 2, 3, 6, 9, 12],
                            factors: [
                                [1.00, 1.00, 0.98, 0.96, 0.95, 0.94],
                                [1.00, 0.98, 0.96, 0.93, 0.92, 0.90],
                                [1.00, 0.97, 0.95, 0.92, 0.90, 0.88]
                            ]
                        },
                        inAirFlat: { 
                            trays: [1, 2, 3], 
                            circuits: [1, 2, 3, 6, 9, 12],
                            factors: [
                                [1.00, 0.97, 0.96, 0.93, 0.92, 0.91],
                                [1.00, 0.95, 0.93, 0.90, 0.89, 0.87],
                                [1.00, 0.94, 0.90, 0.87, 0.86, 0.84]
                            ]
                        },
                        inAirVerticalTrefoil: { 
                            trays: [1, 2, 3], 
                            circuits: [1, 2, 3, 6, 9, 12],
                            factors: [
                                [1.00, 0.98, 0.96, 0.94, 0.93, 0.92],
                                [1.00, 0.96, 0.94, 0.91, 0.90, 0.89],
                                [1.00, 0.95, 0.93, 0.89, 0.88, 0.87]
                            ]
                        }
                    },
                    threeCore: { 
                        buriedDirect: { 
                            cables: [1, 2, 3, 4, 6, 8, 10, 12],
                            spacing: ["Touching", 0.2, 0.4, 0.6, 0.8],
                            factors: [
                                [1.00, 1.00, 1.00, 1.00, 1.00],
                                [0.85, 0.90, 0.95, 0.96, 0.97],
                                [0.75, 0.85, 0.90, 0.92, 0.94],
                                [0.70, 0.80, 0.85, 0.87, 0.89],
                                [0.60, 0.75, 0.80, 0.83, 0.86],
                                [0.55, 0.70, 0.76, 0.80, 0.83],
                                [0.53, 0.68, 0.74, 0.78, 0.81],
                                [0.50, 0.66, 0.72, 0.76, 0.79]
                            ]
                        },
                        inDucts: { 
                            cables: [1, 2, 3, 4, 6, 8], 
                            spacing: ["Touching", 0.2, 0.4, 0.6, 0.8],
                            factors: [
                                [1.00, 1.00, 1.00, 1.00, 1.00],
                                [0.85, 0.90, 0.95, 0.96, 0.97],
                                [0.75, 0.85, 0.90, 0.92, 0.94],
                                [0.70, 0.80, 0.85, 0.88, 0.90],
                                [0.60, 0.75, 0.80, 0.84, 0.86],
                                [0.57, 0.70, 0.76, 0.80, 0.83]
                            ]
                        },
                        inAirHorizontal: { 
                            trays: [1, 2, 3], 
                            cables: [1, 2, 3, 6, 9, 12],
                            factors: [
                                [1.00, 1.00, 0.98, 0.96, 0.95, 0.94],
                                [1.00, 0.98, 0.96, 0.93, 0.92, 0.90],
                                [1.00, 0.97, 0.95, 0.92, 0.90, 0.88]
                            ]
                        },
                        inAirLadder: { 
                            trays: [1, 2, 3], 
                            cables: [1, 2, 3, 6, 9, 12],
                            factors: [
                                [1.00, 1.00, 0.98, 0.96, 0.95, 0.94],
                                [1.00, 0.98, 0.96, 0.93, 0.92, 0.90],
                                [1.00, 0.97, 0.95, 0.92, 0.90, 0.88]
                            ]
                        },
                        inAirVertical: { 
                            trays: [1, 2, 3], 
                            cables: [1, 2, 3, 6, 9, 12],
                            factors: [
                                [1.00, 0.98, 0.96, 0.94, 0.93, 0.92],
                                [1.00, 0.96, 0.94, 0.91, 0.90, 0.89],
                                [1.00, 0.95, 0.93, 0.90, 0.89, 0.87]
                            ]
                        }
                    }
                },
                thermalResistivityFactors: {
                    singleCore: {
                        "3.3-11kV": {
                            buriedDirect: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 25mm²
                                    [1.18, 1.10, 1.00, 0.89, 0.80, 0.74], // 35mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 50mm²
                                    [1.19, 1.10, 1.00, 0.88, 0.79, 0.73], // 70mm²
                                    [1.19, 1.10, 1.00, 0.88, 0.79, 0.73], // 95mm²
                                    [1.19, 1.10, 1.00, 0.88, 0.79, 0.73], // 120mm²
                                    [1.19, 1.10, 1.00, 0.88, 0.79, 0.73], // 150mm²
                                    [1.19, 1.11, 1.00, 0.88, 0.79, 0.73], // 185mm²
                                    [1.19, 1.11, 1.00, 0.88, 0.79, 0.73], // 240mm²
                                    [1.20, 1.11, 1.00, 0.88, 0.79, 0.72], // 300mm²
                                    [1.20, 1.11, 1.00, 0.87, 0.79, 0.72], // 400mm²
                                    [1.20, 1.11, 1.00, 0.87, 0.79, 0.72], // 500mm²
                                    [1.20, 1.11, 1.00, 0.87, 0.78, 0.72], // 630mm²
                                    [1.20, 1.11, 1.00, 0.87, 0.78, 0.72], // 800mm²
                                    [1.21, 1.11, 1.00, 0.87, 0.78, 0.72]  // 1000mm²
                                ]
                            },
                            inDucts: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.11, 1.06, 1.00, 0.92, 0.86, 0.81], // 25mm²
                                    [1.11, 1.06, 1.00, 0.92, 0.86, 0.81], // 35mm²
                                    [1.11, 1.06, 1.00, 0.92, 0.85, 0.80], // 50mm²
                                    [1.11, 1.07, 1.00, 0.92, 0.85, 0.80], // 70mm²
                                    [1.11, 1.07, 1.00, 0.91, 0.85, 0.79], // 95mm²
                                    [1.12, 1.08, 1.00, 0.91, 0.84, 0.79], // 120mm²
                                    [1.13, 1.07, 1.00, 0.91, 0.84, 0.79], // 150mm²
                                    [1.13, 1.07, 1.00, 0.91, 0.84, 0.78], // 185mm²
                                    [1.13, 1.07, 1.00, 0.91, 0.84, 0.78], // 240mm²
                                    [1.13, 1.07, 1.00, 0.91, 0.83, 0.78], // 300mm²
                                    [1.13, 1.07, 1.00, 0.90, 0.83, 0.77], // 400mm²
                                    [1.14, 1.08, 1.00, 0.90, 0.83, 0.77], // 500mm²
                                    [1.14, 1.08, 1.00, 0.90, 0.83, 0.77], // 630mm²
                                    [1.14, 1.08, 1.00, 0.90, 0.82, 0.76], // 800mm²
                                    [1.15, 1.08, 1.00, 0.90, 0.82, 0.76]  // 1000mm²
                                ]
                            }
                        },
                        "22-33kV": {
                            buriedDirect: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.17, 1.09, 1.00, 0.89, 0.81, 0.74], // 35mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.81, 0.74], // 50mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 70mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 95mm²
                                    [1.18, 1.10, 1.00, 0.89, 0.80, 0.74], // 120mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 150mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 185mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.79, 0.73], // 240mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.79, 0.73], // 300mm²
                                    [1.19, 1.11, 1.00, 0.88, 0.79, 0.73], // 400mm²
                                    [1.19, 1.11, 1.00, 0.87, 0.79, 0.73], // 500mm²
                                    [1.19, 1.11, 1.00, 0.87, 0.79, 0.73], // 630mm²
                                    [1.20, 1.11, 1.00, 0.87, 0.78, 0.72], // 800mm²
                                    [1.20, 1.11, 1.00, 0.87, 0.78, 0.72]  // 1000mm²
                                ]
                            },
                            inDucts: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.10, 1.06, 1.00, 0.93, 0.87, 0.83], // 35mm²
                                    [1.10, 1.06, 1.00, 0.93, 0.87, 0.82], // 50mm²
                                    [1.10, 1.06, 1.00, 0.92, 0.86, 0.82], // 70mm²
                                    [1.11, 1.07, 1.00, 0.92, 0.86, 0.81], // 95mm²
                                    [1.11, 1.07, 1.00, 0.92, 0.85, 0.80], // 120mm²
                                    [1.11, 1.07, 1.00, 0.91, 0.85, 0.80], // 150mm²
                                    [1.12, 1.07, 1.00, 0.91, 0.85, 0.79], // 185mm²
                                    [1.12, 1.07, 1.00, 0.91, 0.84, 0.79], // 240mm²
                                    [1.12, 1.07, 1.00, 0.90, 0.84, 0.78], // 300mm²
                                    [1.13, 1.08, 1.00, 0.90, 0.83, 0.77], // 400mm²
                                    [1.13, 1.08, 1.00, 0.89, 0.82, 0.76]  // 500mm²
                                ]
                            }
                        }
                    },
                    threeCore: {
                        "3.3-11kV": {
                            buriedDirect: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 25mm²
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 35mm²
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 50mm²
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 70mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 95mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 120mm²
                                    [1.17, 1.09, 1.00, 0.88, 0.80, 0.74], // 150mm²
                                    [1.17, 1.10, 1.00, 0.88, 0.80, 0.74], // 185mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 240mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 300mm²
                                    [1.18, 1.10, 1.00, 0.87, 0.79, 0.73], // 400mm²
                                    [1.19, 1.11, 1.00, 0.87, 0.79, 0.73]  // 500mm²
                                ]
                            },
                            inDucts: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.10, 1.05, 1.00, 0.93, 0.87, 0.83], // 25mm²
                                    [1.10, 1.05, 1.00, 0.93, 0.87, 0.82], // 35mm²
                                    [1.10, 1.06, 1.00, 0.92, 0.86, 0.82], // 50mm²
                                    [1.10, 1.06, 1.00, 0.92, 0.86, 0.81], // 70mm²
                                    [1.11, 1.06, 1.00, 0.92, 0.85, 0.81], // 95mm²
                                    [1.11, 1.06, 1.00, 0.91, 0.85, 0.80], // 120mm²
                                    [1.11, 1.06, 1.00, 0.91, 0.84, 0.79], // 150mm²
                                    [1.12, 1.07, 1.00, 0.91, 0.84, 0.79], // 185mm²
                                    [1.12, 1.07, 1.00, 0.90, 0.83, 0.78], // 240mm²
                                    [1.12, 1.07, 1.00, 0.90, 0.83, 0.78], // 300mm²
                                    [1.13, 1.07, 1.00, 0.89, 0.82, 0.77], // 400mm²
                                    [1.13, 1.07, 1.00, 0.89, 0.81, 0.76]  // 500mm²
                                ]
                            }
                        },
                        "22-33kV": {
                            buriedDirect: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 35mm²
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 50mm²
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 70mm²
                                    [1.16, 1.09, 1.00, 0.89, 0.81, 0.75], // 95mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 120mm²
                                    [1.17, 1.09, 1.00, 0.89, 0.80, 0.74], // 150mm²
                                    [1.17, 1.10, 1.00, 0.88, 0.80, 0.74], // 185mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 240mm²
                                    [1.18, 1.10, 1.00, 0.88, 0.80, 0.74], // 300mm²
                                    [1.18, 1.10, 1.00, 0.87, 0.79, 0.73], // 400mm²
                                    [1.19, 1.11, 1.00, 0.87, 0.79, 0.73]  // 500mm²
                                ]
                            },
                            inDucts: {
                                resistivities: [1.0, 1.2, 1.5, 2.0, 2.5, 3.0],
                                factors: [
                                    [1.10, 1.05, 1.00, 0.93, 0.87, 0.83], // 35mm²
                                    [1.10, 1.06, 1.00, 0.93, 0.87, 0.82], // 50mm²
                                    [1.10, 1.06, 1.00, 0.92, 0.86, 0.82], // 70mm²
                                    [1.10, 1.06, 1.00, 0.92, 0.86, 0.81], // 95mm²
                                    [1.11, 1.06, 1.00, 0.91, 0.85, 0.80], // 120mm²
                                    [1.11, 1.06, 1.00, 0.91, 0.85, 0.80], // 150mm²
                                    [1.12, 1.07, 1.00, 0.91, 0.84, 0.79], // 185mm²
                                    [1.12, 1.07, 1.00, 0.90, 0.83, 0.78], // 240mm²
                                    [1.12, 1.07, 1.00, 0.90, 0.83, 0.78], // 300mm²
                                    [1.13, 1.07, 1.00, 0.89, 0.82, 0.77], // 400mm²
                                    [1.13, 1.08, 1.00, 0.89, 0.82, 0.76]  // 500mm²
                                ]
                            }
                        }
                    }
                }
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="cabledata.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Cable visualization styles */
        .cable-visualization {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: white !important;
            border: 1px solid #d1d5db;
        }
        .cable-cross-section {
            display: inline-block;
            position: relative;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        .cable-single-core {
            background-color: #6b7280;
            border: 2px solid #4b5563;
            position: relative;
        }
        .cable-single-core::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.4);
        }
        .cable-three-core {
            background-color: #6b7280;
            border: 2px solid #4b5563;
            position: relative;
        }
        .cable-three-core::before {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px dashed rgba(255,255,255,0.4);
        }
        .cable-conductor-copper {
            background: #b45309;
        }
        .cable-conductor-copper::after {
            background: #f59e0b;
        }
        .cable-conductor-aluminum {
            background: #6b7280;
        }
        .cable-conductor-aluminum::after {
            background: #d1d5db;
        }
        .cable-in-duct {
            border: 2px solid #4b5563;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.15);
        }
        .cable-tray {
            background-color: #9ca3af;
            border: 1px solid #6b7280;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        .cable-ground {
            background-color: #e5e7eb;
            background-image: repeating-linear-gradient(0deg, #d1d5db, #d1d5db 1px, transparent 1px, transparent 10px),
                            repeating-linear-gradient(90deg, #d1d5db, #d1d5db 1px, transparent 1px, transparent 10px);
        }
        .depth-marker {
            position: absolute;
            left: 0;
            width: 100%;
            border-top: 1px dashed #64748b;
            z-index: 5;
        }
        .depth-label {
            position: absolute;
            background-color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            z-index: 10;
        }
        .spacing-marker {
            position: absolute;
            height: 2px;
            background-color: #64748b;
            z-index: 5;
        }
        .spacing-arrow {
            position: absolute;
            font-size: 0.7rem;
            color: #4b5563;
            z-index: 5;
        }
        .measurement-line {
            position: absolute;
            background-color: #ef4444;
            z-index: 8;
        }
        .measurement-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            z-index: 8;
        }
        .ruler {
            position: absolute;
            left: 0;
            width: 100%;
            height: 20px;
            bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 8;
        }
        .ruler-tick {
            width: 1px;
            background-color: #64748b;
            position: relative;
        }
        .ruler-tick-major {
            height: 12px;
        }
        .ruler-tick-minor {
            height: 8px;
        }
        .ruler-label {
            position: absolute;
            font-size: 8px;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            color: #4b5563;
        }
        .diagram-title {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 12px;
            font-weight: bold;
            color: #1e3a8a;
            background: rgba(255,255,255,0.7);
            padding: 2px 6px;
            border-radius: 3px;
            z-index: 10;
        }
        .surface-line {
            position: absolute;
            left: 0;
            top: 10%;
            width: 100%;
            border-top: 3px solid #16a34a;
            z-index: 5;
        }
        .coordinate-system {
            position: absolute;
            width: 100%;
            bottom: 25px;
            display: flex;
            justify-content: space-around;
            z-index: 5;
        }
        .coordinate-tick {
            width: 1px;
            height: 10px;
            background-color: #000;
        }
        .coordinate-value {
            position: absolute;
            font-size: 10px;
            bottom: -15px;
            transform: translateX(-50%);
        }
        .measurement-dim {
            position: absolute;
            border-left: 1px solid #ef4444;
            z-index: 8;
        }
        .measurement-dim-horz {
            position: absolute;
            border-top: 1px solid #ef4444;
            z-index: 8;
        }
        .measurement-text {
            position: absolute;
            font-size: 10px;
            color: #ef4444;
            background-color: white;
            padding: 0 2px;
            z-index: 9;
        }
        .phase-label {
            position: absolute;
            background-color: #0ea5e9;
            color: white;
            font-weight: bold;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 2px;
            z-index: 10;
            transform: translateX(-50%);
        }
        .trench-outline {
            position: absolute;
            border: 2px solid #4b5563;
            background-color: #e5e7eb;
            background-image: repeating-linear-gradient(0deg, #d1d5db, #d1d5db 1px, transparent 1px, transparent 10px),
                            repeating-linear-gradient(90deg, #d1d5db, #d1d5db 1px, transparent 1px, transparent 10px);
            z-index: 2;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl bg-gradient-to-b from-blue-50 to-white">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Form Section - 2/3 width on large screens -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200 transition-all duration-300 hover:shadow-xl">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-700 to-blue-500 px-6 py-4 shadow-lg">
                        <h1 class="text-2xl font-bold text-white flex items-center">
                            <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Cable Current Rating Calculator
                        </h1>
                        <p class="text-blue-100">Based on IS 3961 (Part 7) : 2017</p>
                    </div>

                    <!-- Main Form -->
                    <div class="p-6">
                        <form id="cableForm" class="space-y-6">
                            <!-- Cable Type Selection -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 text-gray-800">1. Cable Specifications</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Conductor Material -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Conductor Material</label>
                                        <select id="conductorMaterial" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="copper">Copper</option>
                                            <option value="aluminum">Aluminum</option>
                                        </select>
                                    </div>

                                    <!-- Cable Construction -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cable Construction</label>
                                        <select id="cableConstruction" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="singleCore">Single-Core</option>
                                            <option value="threeCore">Three-Core</option>
                                        </select>
                                    </div>

                                    <!-- Voltage Rating -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Voltage Rating</label>
                                        <select id="voltageRating" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="1.9/3.3kV-3.8/6.6kV">1.9/3.3 kV to 3.8/6.6 kV</option>
                                            <option value="6.6/6.6kV-11/11kV">6.6/6.6 kV to 11/11 kV</option>
                                            <option value="12.7/22kV-19/33kV">12.7/22 kV to 19/33 kV</option>
                                        </select>
                                    </div>

                                    <!-- Conductor Size -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Conductor Size (mm²)</label>
                                        <select id="conductorSize" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Installation Method -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 text-gray-800">2. Installation Method</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Installation Type -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Installation Type</label>
                                        <select id="installationType" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="buriedDirect">Buried Direct in Ground</option>
                                            <option value="inDucts">In Ducts</option>
                                            <option value="inAir">In Air</option>
                                        </select>
                                    </div>

                                    <!-- Arrangement (visible for single-core in ground/ducts) -->
                                    <div id="arrangementContainer" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cable Arrangement</label>
                                        <select id="cableArrangement" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="trefoil">Trefoil</option>
                                            <option value="flatTouching">Flat Touching</option>
                                        </select>
                                    </div>

                                    <!-- Air Installation Options (visible when inAir is selected) -->
                                    <div id="airInstallationOptions" class="hidden md:col-span-2">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Installation Method</label>
                                                <select id="airInstallationMethod" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="perforatedTrays">On Perforated Trays</option>
                                                    <option value="ladderSupports">On Ladder Supports/Cleats</option>
                                                    <option value="verticalTrays">On Vertical Trays</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Arrangement</label>
                                                <select id="airArrangement" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="trefoil">Trefoil</option>
                                                    <option value="flat">Flat</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Derating Factors -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 text-gray-800">3. Derating Factors</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- Ambient/Ground Temperature -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" id="temperatureLabel">Ground Temperature (°C)</label>
                                        <select id="temperature" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                            <option value="23">23</option>
                                            <option value="24">24</option>
                                            <option value="25">25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                            <option value="31">31</option>
                                            <option value="32">32</option>
                                            <option value="33">33</option>
                                            <option value="34">34</option>
                                            <option value="35">35</option>
                                            <option value="36">36</option>
                                            <option value="37">37</option>
                                            <option value="38">38</option>
                                            <option value="39">39</option>
                                            <option value="40">40</option>
                                            <option value="41">41</option>
                                            <option value="42">42</option>
                                            <option value="43">43</option>
                                            <option value="44">44</option>
                                            <option value="45">45</option>
                                            <option value="46">46</option>
                                            <option value="47">47</option>
                                            <option value="48">48</option>
                                            <option value="49">49</option>
                                            <option value="50">50</option>
                                            <option value="51">51</option>
                                            <option value="52">52</option>
                                            <option value="53">53</option>
                                            <option value="54">54</option>
                                            <option value="55">55</option>
                                            <option value="56">56</option>
                                            <option value="57">57</option>
                                            <option value="58">58</option>
                                            <option value="59">59</option>
                                            <option value="60">60</option>
                                        </select>
                                    </div>

                                    <!-- Depth of Laying -->
                                    <div id="depthContainer">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Depth of Laying (mm)</label>
                                        <select id="depthOfLaying" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="900">900</option>
                                            <option value="1050">1050</option>
                                            <option value="1200">1200</option>
                                            <option value="1500">1500</option>
                                            <option value="1800">1800</option>
                                            <option value="2000">2000</option>
                                            <option value="2500">2500</option>
                                            <option value="3000">3000</option>
                                        </select>
                                    </div>

                                    <!-- Soil Thermal Resistivity -->
                                    <div id="resistivityContainer">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Soil Thermal Resistivity (K.m/W)</label>
                                        <select id="thermalResistivity" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="1.0">1.0</option>
                                            <option value="1.2">1.2</option>
                                            <option value="1.5" selected>1.5</option>
                                            <option value="2.0">2.0</option>
                                            <option value="2.5">2.5</option>
                                            <option value="3.0">3.0</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Grouping Factors -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 text-gray-800">4. Grouping Factors</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- Number of Circuits/Cables -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" id="groupingNumberLabel">Number of Circuits</label>
                                        <select id="numberOfCircuits" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                        </select>
                                    </div>

                                    <!-- Spacing Between Cables -->
                                    <div id="spacingContainer">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Spacing Between Groups (mm)</label>
                                        <select id="cableSpacing" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="Touching">Touching</option>
                                            <option value="200">200</option>
                                            <option value="400">400</option>
                                            <option value="600">600</option>
                                            <option value="800">800</option>
                                        </select>
                                    </div>

                                    <!-- Number of Trays (visible for in-air installations) -->
                                    <div id="traysContainer" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Number of Trays</label>
                                        <select id="numberOfTrays" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Load Requirements -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 text-gray-800">1.1. Load Requirements</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Required Current -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Required Current (A)</label>
                                        <input type="number" id="requiredCurrent" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 250">
                                    </div>
                                    
                                    <!-- Cable Length -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cable Length (m)</label>
                                        <input type="number" id="cableLength" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 100">
                                    </div>

                                    <!-- Supply Voltage -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Supply Voltage (V)</label>
                                        <input type="number" id="supplyVoltage" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 11000">
                                    </div>

                                    <!-- Max Voltage Drop % -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Max Voltage Drop (%)</label>
                                        <input type="number" id="maxVoltageDrop" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="5">
                                    </div>
                                </div>
                            </div>

                            <!-- Short Circuit Parameters -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 text-gray-800">3.1. Short Circuit Parameters</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Short Circuit Current -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Short Circuit Current (kA)</label>
                                        <input type="number" id="shortCircuitCurrent" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 25">
                                    </div>

                                    <!-- Fault Duration -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fault Duration (s)</label>
                                        <input type="number" id="faultDuration" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Calculate Button -->
                            <div class="pt-4">
                                <button type="button" id="calculateBtn" onclick="directCalculate()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105">
                                    <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    Calculate & Recommend Cable
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Results Section - 1/3 width on large screens -->
            <div class="lg:col-span-1">
                <div id="resultsSection" class="bg-white rounded-lg shadow-lg overflow-hidden h-full border border-gray-200 transition-all duration-300 hover:shadow-xl">
                    <div class="bg-gradient-to-r from-blue-700 to-blue-500 px-6 py-4 shadow-lg">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Calculation Results
                        </h2>
                        <p class="text-blue-100">Click calculate after selecting parameters</p>
                    </div>
                    <div class="p-6">
                        <!-- Cable Visualization -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Cable Configuration</h3>
                            <div id="cableVisualization" class="h-48 w-full bg-white border border-gray-300 rounded-md flex items-center justify-center">
                                <div class="text-gray-400 text-center">Cable visualization will appear here after calculation</div>
                            </div>
                        </div>
                        
                        <!-- Base Current Rating -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Base Current Rating</h3>
                            <p class="text-gray-600 mb-1">Selected cable configuration:</p>
                            <p id="baseRatingDesc" class="text-sm text-gray-500 mb-3"></p>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Current Rating:</span>
                                <span id="baseRatingValue" class="text-2xl font-bold text-blue-600">-</span>
                            </div>
                        </div>

                        <!-- Applied Derating Factors -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Applied Derating Factors</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600" id="temperatureFactorLabel">Temperature:</span>
                                    <span id="temperatureFactorValue" class="font-medium">1.00</span>
                                </div>
                                <div class="flex justify-between" id="depthFactorRow">
                                    <span class="text-gray-600">Depth of Laying:</span>
                                    <span id="depthFactorValue" class="font-medium">1.00</span>
                                </div>
                                <div class="flex justify-between" id="resistivityFactorRow">
                                    <span class="text-gray-600">Soil Resistivity:</span>
                                    <span id="resistivityFactorValue" class="font-medium">1.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600" id="groupingFactorLabel">Grouping:</span>
                                    <span id="groupingFactorValue" class="font-medium">1.00</span>
                                </div>
                                <div class="border-t border-gray-200 my-2"></div>
                                <div class="flex justify-between">
                                    <span class="text-gray-800 font-medium">Total Derating Factor:</span>
                                    <span id="totalDeratingFactor" class="font-bold">1.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Final Result -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-800">Final Current Rating</h3>
                                    <p class="text-sm text-blue-600">After applying all derating factors</p>
                                </div>
                                <span id="finalRatingValue" class="text-3xl font-bold text-blue-700">- A</span>
                            </div>
                        </div>

                        <!-- Add right after the Final Result section in the results div -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-6">
                            <h3 class="text-lg font-semibold text-green-800 mb-2">Economical Cable Recommendation</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Recommended Size:</span>
                                    <span id="recommendedSize" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Safety Margin:</span>
                                    <span id="safetyMargin" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Short Circuit Verification</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Short Circuit Current:</span>
                                    <span id="shortCircuitValue" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Maximum Withstand:</span>
                                    <span id="shortCircuitWithstand" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Status:</span>
                                    <span id="shortCircuitStatus" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Voltage Drop Analysis</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Voltage Drop:</span>
                                    <span id="voltageDropValue" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Percentage:</span>
                                    <span id="voltageDropPercent" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Status:</span>
                                    <span id="voltageDropStatus" class="font-medium">-</span>
                                </div>
                                <div class="mt-4">
                                    <canvas id="voltageDropChart" width="100%" height="150"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Power Loss Analysis</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Power Loss:</span>
                                    <span id="powerLossValue" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Efficiency:</span>
                                    <span id="powerEfficiency" class="font-medium">-</span>
                                </div>
                                <div class="mt-4">
                                    <canvas id="powerLossChart" width="100%" height="150"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <button id="downloadPdfBtn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center w-full shadow-md hover:shadow-lg transform hover:scale-105">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Results (PDF)
                            </button>
                        </div>

                        <!-- Notes -->
                        <div class="text-sm text-gray-600">
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get references to all form elements
            const conductorMaterial = document.getElementById('conductorMaterial');
            const cableConstruction = document.getElementById('cableConstruction');
            const voltageRating = document.getElementById('voltageRating');
            const conductorSize = document.getElementById('conductorSize');
            const installationType = document.getElementById('installationType');
            const arrangementContainer = document.getElementById('arrangementContainer');
            const cableArrangement = document.getElementById('cableArrangement');
            const airInstallationOptions = document.getElementById('airInstallationOptions');
            const airInstallationMethod = document.getElementById('airInstallationMethod');
            const airArrangement = document.getElementById('airArrangement');
            const temperatureLabel = document.getElementById('temperatureLabel');
            const temperature = document.getElementById('temperature');
            const depthContainer = document.getElementById('depthContainer');
            const depthOfLaying = document.getElementById('depthOfLaying');
            const resistivityContainer = document.getElementById('resistivityContainer');
            const thermalResistivity = document.getElementById('thermalResistivity');
            const groupingNumberLabel = document.getElementById('groupingNumberLabel');
            const numberOfCircuits = document.getElementById('numberOfCircuits');
            const spacingContainer = document.getElementById('spacingContainer');
            const cableSpacing = document.getElementById('cableSpacing');
            const traysContainer = document.getElementById('traysContainer');
            const numberOfTrays = document.getElementById('numberOfTrays');
            const calculateBtn = document.getElementById('calculateBtn');
            const resultsSection = document.getElementById('resultsSection');
            const baseRatingDesc = document.getElementById('baseRatingDesc');
            const baseRatingValue = document.getElementById('baseRatingValue');
            const temperatureFactorLabel = document.getElementById('temperatureFactorLabel');
            const temperatureFactorValue = document.getElementById('temperatureFactorValue');
            const depthFactorRow = document.getElementById('depthFactorRow');
            const depthFactorValue = document.getElementById('depthFactorValue');
            const resistivityFactorRow = document.getElementById('resistivityFactorRow');
            const resistivityFactorValue = document.getElementById('resistivityFactorValue');
            const groupingFactorLabel = document.getElementById('groupingFactorLabel');
            const groupingFactorValue = document.getElementById('groupingFactorValue');
            const totalDeratingFactor = document.getElementById('totalDeratingFactor');
            const finalRatingValue = document.getElementById('finalRatingValue');

            // Update conductor size options based on cable construction
            function updateConductorSizes() {
                console.log("Attempting to update conductor sizes...");

                if (!cableConstruction) {
                    console.error("Conductor size update: cableConstruction element not found.");
                    return;
                }
                // Ensure conductorSize element is available before trying to modify it
                const conductorSizeEl = document.getElementById('conductorSize'); // Re-fetch or ensure it's globally available from the top declarations
                if (!conductorSizeEl) {
                    console.error("Conductor size update: conductorSize select element (id='conductorSize') not found in DOM.");
                    return;
                }

                if (typeof cableData === 'undefined') {
                    console.error("Conductor size update: cableData object is not defined. Ensure cabledata.js is loaded correctly before this script runs and defines the global 'cableData' variable.");
                    conductorSizeEl.innerHTML = '<option value="">Error: Cable data not loaded</option>';
                    return;
                }
                if (!cableData.conductorSizes) {
                    console.error("Conductor size update: cableData.conductorSizes is not defined. Check cabledata.js structure.");
                    conductorSizeEl.innerHTML = '<option value="">Error: Conductor size data structure missing</option>';
                    return;
                }

                const construction = cableConstruction.value;
                console.log("Selected cable construction for conductor sizes:", construction);

                let sizes;
                if (construction === 'singleCore') {
                    sizes = cableData.conductorSizes.singleCore;
                    if (!sizes) console.error("cableData.conductorSizes.singleCore is undefined. Check cabledata.js.");
                } else if (construction === 'threeCore') {
                    sizes = cableData.conductorSizes.threeCore;
                    if (!sizes) console.error("cableData.conductorSizes.threeCore is undefined. Check cabledata.js.");
                } else {
                    console.error("Conductor size update: Unknown cable construction value:", construction);
                    conductorSizeEl.innerHTML = '<option value="">Error: Invalid construction type</option>';
                    return;
                }

                if (!sizes || !Array.isArray(sizes)) {
                    console.error("Conductor size update: 'sizes' array is undefined, null, or not an array for construction:", construction, "Actual value of sizes:", sizes);
                    conductorSizeEl.innerHTML = `<option value="">Error: No size data for ${construction}</option>`;
                    return;
                }
                
                conductorSizeEl.innerHTML = ''; // Clear previous options
                if (sizes.length === 0) {
                    console.warn("Conductor size update: 'sizes' array is empty for construction:", construction);
                    conductorSizeEl.innerHTML = `<option value="">No sizes available for ${construction}</option>`;
                } else {
                    sizes.forEach(size => {
                        const option = document.createElement('option');
                        option.value = size;
                        option.textContent = `${size} mm²`;
                        conductorSizeEl.appendChild(option);
                    });
                    console.log(`Populated conductor sizes for ${construction}: ${sizes.length} options added.`);
                }
            }

            // Update form fields based on installation type
            function updateInstallationFields() {
                const type = installationType.value;
                
                // Show/hide arrangement for single-core cables
                if (cableConstruction.value === 'singleCore' && (type === 'buriedDirect' || type === 'inDucts')) {
                    arrangementContainer.classList.remove('hidden');
                } else {
                    arrangementContainer.classList.add('hidden');
                }
                
                // Show/hide air installation options
                if (type === 'inAir') {
                    airInstallationOptions.classList.remove('hidden');
                    
                    // Update grouping label based on cable construction
                    if (cableConstruction.value === 'singleCore') {
                        groupingNumberLabel.textContent = 'Number of Circuits';
                    } else {
                        groupingNumberLabel.textContent = 'Number of Cables';
                    }
                    
                    // Show trays selector
                    traysContainer.classList.remove('hidden');
                    spacingContainer.classList.add('hidden');
                } else {
                    airInstallationOptions.classList.add('hidden');
                    
                    // Update grouping label
                    if (cableConstruction.value === 'singleCore') {
                        groupingNumberLabel.textContent = 'Number of Circuits';
                    } else {
                        groupingNumberLabel.textContent = 'Number of Cables';
                    }
                    
                    // Hide trays selector
                    traysContainer.classList.add('hidden');
                    spacingContainer.classList.remove('hidden');
                }
                
                // Update temperature label
                temperatureLabel.textContent = type === 'inAir' ? 'Ambient Air Temperature (°C)' : 'Ground Temperature (°C)';
                
                // Show/hide depth and resistivity fields
                if (type === 'inAir') {
                    depthContainer.classList.add('hidden');
                    resistivityContainer.classList.add('hidden');
                } else {
                    depthContainer.classList.remove('hidden');
                    resistivityContainer.classList.remove('hidden');
                }
            }

            // Render cable visualization
            function renderCableVisualization(params) {
                const {
                    material,
                    construction,
                    size,
                    installation,
                    arrangement,
                    depth,
                    circuits,
                    spacing,
                    airMethod,
                    airArrangement,
                    trays
                } = params;
                
                const visualizationContainer = document.getElementById('cableVisualization');
                visualizationContainer.innerHTML = ''; // Clear previous visualization
                visualizationContainer.classList.add('cable-visualization');
                visualizationContainer.style.backgroundColor = 'white'; 
                
                // Add coordinate system at the bottom
                addCoordinateSystem(visualizationContainer);
                
                // Create visualization based on installation method
                if (installation === 'buriedDirect' || installation === 'inDucts') {
                    // Add surface line for buried/duct cables
                    const surfaceLine = document.createElement('div');
                    surfaceLine.className = 'surface-line';
                    visualizationContainer.appendChild(surfaceLine);
                    
                    // For buried or ducts
                    renderCymcapStyle({
                        container: visualizationContainer,
                        material,
                        construction,
                        size,
                        installation,
                        arrangement,
                        depth,
                        circuits,
                        spacing
                    });
                } else if (installation === 'inAir') {
                    // For air installation - we'll adapt it to a similar technical style
                    renderCymcapInAir({
                        container: visualizationContainer,
                        material,
                        construction,
                        size,
                        airMethod,
                        airArrangement,
                        circuits,
                        trays
                    });
                }
            }
            
            // Add coordinate system similar to CYMCAP
            function addCoordinateSystem(container) {
                const coordSystem = document.createElement('div');
                coordSystem.className = 'coordinate-system';
                
                // Create 7 ticks for the coordinate system
                const ticks = 7;
                for (let i = 0; i < ticks; i++) {
                    const tick = document.createElement('div');
                    tick.className = 'coordinate-tick';
                    
                    const value = document.createElement('div');
                    value.className = 'coordinate-value';
                    value.textContent = ((i - 3) * 0.5).toFixed(1);
                    
                    tick.appendChild(value);
                    coordSystem.appendChild(tick);
                }
                
                container.appendChild(coordSystem);
            }
            
            // Render CYMCAP style visualization for buried or duct cables
            function renderCymcapStyle(params) {
                const {
                    container,
                    material,
                    construction,
                    size,
                    installation,
                    arrangement,
                    depth,
                    circuits,
                    spacing
                } = params;
                
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;

                // Calculate cable size based on actual cross-section
                // Formula approximate: diameter in mm ≈ 2 * sqrt(size in mm²) + insulation & sheath (roughly ~10-20mm)
                const cableDiameter = Math.min(2 * Math.sqrt(size) + 15, 100); // Limit max size for display purposes
                
                // Calculate trench dimensions
                // Width = cable diameter (or 3 cables if flat) + clearance on both sides (50mm each side)
                let cableArrangementWidth;
                if (construction === 'singleCore') {
                    if (arrangement === 'trefoil') {
                        cableArrangementWidth = cableDiameter * 2; // Trefoil uses about 2x cable diameter
                    } else {
                        cableArrangementWidth = cableDiameter * 3; // Flat uses about 3x cable diameter
                    }
                } else {
                    cableArrangementWidth = cableDiameter; // Single three-core cable
                }
                
                const clearance = 50; // 50mm clearance on each side
                const trenchWidthMm = cableArrangementWidth + (clearance * 2);
                const trenchWidthM = trenchWidthMm / 1000; // Convert to meters for display
                
                // Scale trench for display
                const scaleFactor = 0.6; // Scale factor to fit in visualization
                const trenchWidth = Math.min(containerWidth * scaleFactor, trenchWidthMm * 1.5);
                const trenchHeight = Math.round(depth / 900 * containerHeight * 0.4);
                const trenchTop = Math.round(containerHeight * 0.15);
                
                // Create trench area
                const trench = document.createElement('div');
                trench.className = 'trench-outline';
                trench.style.width = `${trenchWidth}px`;
                trench.style.height = `${trenchHeight}px`;
                trench.style.left = `${(containerWidth - trenchWidth) / 2}px`;
                trench.style.top = `${trenchTop}px`;
                container.appendChild(trench);
                
                // Add width dimension for trench (at bottom)
                const widthDim = document.createElement('div');
                widthDim.className = 'measurement-dim-horz';
                widthDim.style.width = `${trenchWidth}px`;
                widthDim.style.left = `${(containerWidth - trenchWidth) / 2}px`;
                widthDim.style.top = `${trenchTop + trenchHeight + 20}px`;
                container.appendChild(widthDim);
                
                // Left vertical line for width measurement
                const leftDim = document.createElement('div');
                leftDim.className = 'measurement-dim';
                leftDim.style.height = '10px';
                leftDim.style.left = `${(containerWidth - trenchWidth) / 2}px`;
                leftDim.style.top = `${trenchTop + trenchHeight + 15}px`;
                container.appendChild(leftDim);
                
                // Right vertical line for width measurement
                const rightDim = document.createElement('div');
                rightDim.className = 'measurement-dim';
                rightDim.style.height = '10px';
                rightDim.style.left = `${(containerWidth + trenchWidth) / 2}px`;
                rightDim.style.top = `${trenchTop + trenchHeight + 15}px`;
                container.appendChild(rightDim);
                
                // Label for width
                const widthLabel = document.createElement('div');
                widthLabel.className = 'measurement-text';
                widthLabel.textContent = `${trenchWidthM.toFixed(3)} m`;
                widthLabel.style.left = `${containerWidth / 2}px`;
                widthLabel.style.top = `${trenchTop + trenchHeight + 15}px`;
                widthLabel.style.transform = 'translateX(-50%)';
                container.appendChild(widthLabel);
                
                // Add NGL label (Natural Ground Level)
                const nglLabel = document.createElement('div');
                nglLabel.className = 'depth-label';
                nglLabel.textContent = 'NGL';
                nglLabel.style.top = '7%';
                nglLabel.style.left = '10px';
                container.appendChild(nglLabel);
                
                // Add height dimension for trench - from NGL to bottom (at right side)
                const heightDim = document.createElement('div');
                heightDim.className = 'measurement-dim';
                heightDim.style.height = `${trenchTop + trenchHeight - containerHeight * 0.1}px`;
                heightDim.style.left = `${(containerWidth + trenchWidth) / 2 + 20}px`;
                heightDim.style.top = `${containerHeight * 0.1}px`; // NGL level
                container.appendChild(heightDim);
                
                // Top horizontal line for height measurement
                const topDim = document.createElement('div');
                topDim.className = 'measurement-dim-horz';
                topDim.style.width = '10px';
                topDim.style.left = `${(containerWidth + trenchWidth) / 2 + 15}px`;
                topDim.style.top = `${containerHeight * 0.1}px`; // NGL level
                container.appendChild(topDim);
                
                // Bottom horizontal line for height measurement
                const bottomDim = document.createElement('div');
                bottomDim.className = 'measurement-dim-horz';
                bottomDim.style.width = '10px';
                bottomDim.style.left = `${(containerWidth + trenchWidth) / 2 + 15}px`;
                bottomDim.style.top = `${trenchTop + trenchHeight}px`;
                container.appendChild(bottomDim);
                
                // Label for depth (from NGL)
                const heightLabel = document.createElement('div');
                heightLabel.className = 'measurement-text';
                heightLabel.textContent = `${(depth/1000).toFixed(3)} m`;
                heightLabel.style.left = `${(containerWidth + trenchWidth) / 2 + 35}px`;
                heightLabel.style.top = `${(containerHeight * 0.1 + trenchTop + trenchHeight) / 2}px`;
                heightLabel.style.transform = 'translateY(-50%)';
                container.appendChild(heightLabel);
                
                // Calculate cable positions
                const positions = [];
                const centerX = containerWidth / 2;
                const centerY = trenchTop + trenchHeight * 0.65; // Position at 65% of trench depth
                
                if (construction === 'singleCore') {
                    if (arrangement === 'trefoil') {
                        // Trefoil arrangement
                        const offset = cableDiameter * 0.6;
                        positions.push(
                            { x: centerX, y: centerY - offset / 1.5, phase: '3-core' },
                            { x: centerX - offset, y: centerY + offset / 2, phase: 'Ph. B' },
                            { x: centerX + offset, y: centerY + offset / 2, phase: 'Ph. C' }
                        );
                    } else {
                        // Flat arrangement
                        const offset = cableDiameter * 1.2;
                        positions.push(
                            { x: centerX - offset, y: centerY, phase: 'Ph. A' },
                            { x: centerX, y: centerY, phase: 'Ph. B' },
                            { x: centerX + offset, y: centerY, phase: 'Ph. C' }
                        );
                    }
                } else {
                    // Three-core cable - single position
                    positions.push({ x: centerX, y: centerY, phase: '3-core' });
                }
                
                // Cable diameter for display (scaled)
                const displayCableDiameter = Math.max(cableDiameter * (trenchWidth / trenchWidthMm) * 0.7, 12);
                
                // Create info text showing cable size
                const cableInfoLabel = document.createElement('div');
                cableInfoLabel.className = 'phase-label';
                cableInfoLabel.textContent = construction === 'singleCore' ? 
                    `${size} mm² ${material === 'copper' ? 'Cu' : 'Al'} Single-Core` : 
                    `${size} mm² ${material === 'copper' ? 'Cu' : 'Al'} 3-Core`;
                cableInfoLabel.style.left = `${centerX}px`;
                cableInfoLabel.style.top = `${trenchTop - 30}px`;
                cableInfoLabel.style.width = 'auto';
                container.appendChild(cableInfoLabel);
                
                // Create cables
                for (let i = 0; i < positions.length; i++) {
                    const pos = positions[i];
                    
                    // Create cable
                    const cable = document.createElement('div');
                    cable.className = `cable-cross-section cable-${construction} cable-conductor-${material}`;
                    cable.style.width = `${displayCableDiameter}px`;
                    cable.style.height = `${displayCableDiameter}px`;
                    cable.style.left = `${pos.x - displayCableDiameter/2}px`;
                    cable.style.top = `${pos.y - displayCableDiameter/2}px`;
                    cable.style.position = 'absolute';
                    
                    // Add duct if in ducts
                    if (installation === 'inDucts') {
                        const duct = document.createElement('div');
                        duct.className = 'cable-in-duct';
                        duct.style.width = `${displayCableDiameter * 1.5}px`;
                        duct.style.height = `${displayCableDiameter * 1.5}px`;
                        duct.style.position = 'absolute';
                        duct.style.left = `${pos.x - displayCableDiameter*1.5/2}px`;
                        duct.style.top = `${pos.y - displayCableDiameter*1.5/2}px`;
                        container.appendChild(duct);
                    }
                    
                    container.appendChild(cable);
                    
                    // Add phase label to cable
                    if (construction === 'singleCore' || (construction === 'threeCore' && i === 0)) {
                        if (positions.length > 1) {
                            const cableLabel = document.createElement('div');
                            cableLabel.style.position = 'absolute';
                            cableLabel.style.top = '50%';
                            cableLabel.style.left = '50%';
                            cableLabel.style.transform = 'translate(-50%, -50%)';
                            cableLabel.style.color = 'white';
                            cableLabel.style.fontWeight = 'bold';
                            cableLabel.style.fontSize = '10px';
                            cableLabel.style.textShadow = '0 0 2px black';
                            
                            if (pos.phase === '3-core') {
                                cableLabel.textContent = '3φ';
                            } else {
                                cableLabel.textContent = pos.phase.replace('Ph. ', '');
                            }
                            
                            cable.appendChild(cableLabel);
                        }
                    }
                }
            }
            
            // Render CYMCAP style for in-air installations
            function renderCymcapInAir(params) {
                const {
                    container,
                    material,
                    construction,
                    size,
                    airMethod,
                    airArrangement,
                    circuits,
                    trays
                } = params;
                
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;
                
                // Create support structure
                const structureWidth = Math.min(containerWidth * 0.7, 400);
                const structureHeight = Math.min(containerHeight * 0.6, 200);
                const structureTop = Math.round(containerHeight * 0.15);
                
                // Label with air installation method
                const methodLabel = document.createElement('div');
                methodLabel.className = 'diagram-title';
                methodLabel.style.top = '5px';
                
                if (airMethod === 'perforatedTrays') {
                    methodLabel.textContent = 'Cables on Perforated Trays';
                } else if (airMethod === 'ladderSupports') {
                    methodLabel.textContent = 'Cables on Ladder Supports';
                } else {
                    methodLabel.textContent = 'Cables on Vertical Trays';
                }
                
                container.appendChild(methodLabel);
                
                // Calculate cable size proportionally
                const cableSize = Math.min(size / 10, 50);
                const cableDiameter = cableSize;
                
                for (let t = 0; t < trays; t++) {
                    // Create tray
                    const trayElement = document.createElement('div');
                    trayElement.className = 'cable-tray';
                    trayElement.style.position = 'absolute';
                    trayElement.style.width = `${structureWidth}px`;
                    trayElement.style.height = '8px';
                    trayElement.style.left = `${(containerWidth - structureWidth) / 2}px`;
                    trayElement.style.top = `${structureTop + t * (structureHeight / Math.max(trays, 1))}px`;
                    
                    if (airMethod === 'ladderSupports') {
                        trayElement.style.background = 'repeating-linear-gradient(90deg, #9ca3af, #9ca3af 10px, transparent 10px, transparent 30px)';
                    }
                    
                    container.appendChild(trayElement);
                    
                    // Tray label
                    const trayLabel = document.createElement('div');
                    trayLabel.className = 'phase-label';
                    trayLabel.textContent = `Tray ${t+1}`;
                    trayLabel.style.left = `${(containerWidth - structureWidth) / 2 - 50}px`;
                    trayLabel.style.top = `${structureTop + t * (structureHeight / Math.max(trays, 1))}px`;
                    trayLabel.style.transform = 'none';
                    container.appendChild(trayLabel);
                    
                    // Add cables to tray
                    const cablesPerTray = Math.ceil(circuits / trays);
                    for (let c = 0; c < cablesPerTray; c++) {
                        const circuitIndex = t * cablesPerTray + c;
                        if (circuitIndex >= circuits) break;
                        
                        const cableSpacing = structureWidth / (cablesPerTray + 1);
                        const cableX = (containerWidth - structureWidth) / 2 + (c + 1) * cableSpacing;
                        const cableY = structureTop + t * (structureHeight / Math.max(trays, 1)) - cableDiameter - 5;
                        
                        if (construction === 'singleCore') {
                            // Three cables per circuit for single core
                            if (airArrangement === 'trefoil') {
                                // Trefoil arrangement
                                const offset = cableDiameter * 0.8;
                                
                                // Create three cables in trefoil
                                createCable({
                                    container,
                                    x: cableX,
                                    y: cableY - offset,
                                    diameter: cableDiameter,
                                    material,
                                    construction,
                                    label: 'A'
                                });
                                
                                createCable({
                                    container,
                                    x: cableX - offset,
                                    y: cableY,
                                    diameter: cableDiameter,
                                    material,
                                    construction,
                                    label: 'B'
                                });
                                
                                createCable({
                                    container,
                                    x: cableX + offset,
                                    y: cableY,
                                    diameter: cableDiameter,
                                    material,
                                    construction,
                                    label: 'C'
                                });
                                
                                // Phase label
                                const phaseLabel = document.createElement('div');
                                phaseLabel.className = 'phase-label';
                                phaseLabel.textContent = `Circuit ${circuitIndex + 1}`;
                                phaseLabel.style.left = `${cableX}px`;
                                phaseLabel.style.top = `${cableY - offset - cableDiameter - 10}px`;
                                container.appendChild(phaseLabel);
                                
                            } else {
                                // Flat arrangement
                                const offset = cableDiameter * 1.2;
                                
                                createCable({
                                    container,
                                    x: cableX - offset,
                                    y: cableY,
                                    diameter: cableDiameter,
                                    material,
                                    construction,
                                    label: 'A'
                                });
                                
                                createCable({
                                    container,
                                    x: cableX,
                                    y: cableY,
                                    diameter: cableDiameter,
                                    material,
                                    construction,
                                    label: 'B'
                                });
                                
                                createCable({
                                    container,
                                    x: cableX + offset,
                                    y: cableY,
                                    diameter: cableDiameter,
                                    material,
                                    construction,
                                    label: 'C'
                                });
                                
                                // Phase label
                                const phaseLabel = document.createElement('div');
                                phaseLabel.className = 'phase-label';
                                phaseLabel.textContent = `Circuit ${circuitIndex + 1}`;
                                phaseLabel.style.left = `${cableX}px`;
                                phaseLabel.style.top = `${cableY - cableDiameter - 10}px`;
                                container.appendChild(phaseLabel);
                            }
                        } else {
                            // Single cable for three-core
                            createCable({
                                container,
                                x: cableX,
                                y: cableY,
                                diameter: cableDiameter * 1.4,
                                material,
                                construction,
                                label: '3φ'
                            });
                            
                            // Cable label
                            const cableLabel = document.createElement('div');
                            cableLabel.className = 'phase-label';
                            cableLabel.textContent = `Cable ${circuitIndex + 1}`;
                            cableLabel.style.left = `${cableX}px`;
                            cableLabel.style.top = `${cableY - cableDiameter - 10}px`;
                            container.appendChild(cableLabel);
                        }
                    }
                }
                
                // Add dimension for structure width
                const widthDim = document.createElement('div');
                widthDim.className = 'measurement-dim-horz';
                widthDim.style.width = `${structureWidth}px`;
                widthDim.style.left = `${(containerWidth - structureWidth) / 2}px`;
                widthDim.style.top = `${structureTop + structureHeight + 20}px`;
                container.appendChild(widthDim);
                
                // Left vertical line for width measurement
                const leftDim = document.createElement('div');
                leftDim.className = 'measurement-dim';
                leftDim.style.height = '10px';
                leftDim.style.left = `${(containerWidth - structureWidth) / 2}px`;
                leftDim.style.top = `${structureTop + structureHeight + 15}px`;
                container.appendChild(leftDim);
                
                // Right vertical line for width measurement
                const rightDim = document.createElement('div');
                rightDim.className = 'measurement-dim';
                rightDim.style.height = '10px';
                rightDim.style.left = `${(containerWidth + structureWidth) / 2}px`;
                rightDim.style.top = `${structureTop + structureHeight + 15}px`;
                container.appendChild(rightDim);
                
                // Label for width
                const widthLabel = document.createElement('div');
                widthLabel.className = 'measurement-text';
                widthLabel.textContent = '1.200 m';
                widthLabel.style.left = `${containerWidth / 2}px`;
                widthLabel.style.top = `${structureTop + structureHeight + 15}px`;
                widthLabel.style.transform = 'translateX(-50%)';
                container.appendChild(widthLabel);
            }
            
            // Create a readable description of cable configuration
            function getCableConfigDescription(params) {
                const {
                    material,
                    construction,
                    size,
                    installation,
                    arrangement,
                    circuits
                } = params;
                
                const materialName = material === 'copper' ? 'Cu' : 'Al';
                const circuitText = circuits > 1 ? `${circuits} × ` : '';
                const sizeText = `${size}mm²`;
                
                if (construction === 'singleCore') {
                    const arrangementText = arrangement === 'trefoil' ? 'Trefoil' : 'Flat Formation';
                    return `${circuitText}${materialName} ${sizeText} Single-Core (${arrangementText})`;
                } else {
                    return `${circuitText}${materialName} ${sizeText} Three-Core Cable`;
                }
            }
            
            // Add ruler to visualization
            function addRuler(container, width) {
                const ruler = document.createElement('div');
                ruler.className = 'ruler';
                
                const numTicks = 11;
                const tickSpacing = width / (numTicks - 1);
                
                for (let i = 0; i < numTicks; i++) {
                    const tick = document.createElement('div');
                    tick.className = i % 5 === 0 ? 'ruler-tick ruler-tick-major' : 'ruler-tick ruler-tick-minor';
                    tick.style.left = `${i * tickSpacing}px`;
                    
                    if (i % 5 === 0) {
                        const label = document.createElement('span');
                        label.className = 'ruler-label';
                        label.textContent = `${i * 20}cm`;
                        tick.appendChild(label);
                    }
                    
                    ruler.appendChild(tick);
                }
                
                container.appendChild(ruler);
            }
            
            // Render buried or duct cables
            function renderBuriedOrDuctCables(params) {
                const {
                    container,
                    material,
                    construction,
                    size,
                    installation,
                    arrangement,
                    depth,
                    circuits,
                    spacing,
                    containerWidth,
                    containerHeight
                } = params;
                
                // Add depth marker
                const depthPercent = Math.min(65, Math.max(25, (depth / 3000) * 50 + 25));
                const depthMarker = document.createElement('div');
                depthMarker.className = 'depth-marker';
                depthMarker.style.top = `${depthPercent}%`;
                container.appendChild(depthMarker);
                
                // Add vertical measurement line
                const verticalLine = document.createElement('div');
                verticalLine.className = 'measurement-line';
                verticalLine.style.width = '2px';
                verticalLine.style.height = `${depthPercent - 15}%`;
                verticalLine.style.top = '15%';
                verticalLine.style.right = '40px';
                container.appendChild(verticalLine);
                
                // Add arrow heads
                const topArrow = document.createElement('div');
                topArrow.className = 'measurement-arrow';
                topArrow.style.top = '15%';
                topArrow.style.right = '36px';
                topArrow.style.borderWidth = '4px';
                topArrow.style.borderColor = 'transparent #64748b transparent transparent';
                container.appendChild(topArrow);
                
                const bottomArrow = document.createElement('div');
                bottomArrow.className = 'measurement-arrow';
                bottomArrow.style.top = `${depthPercent - 2}%`;
                bottomArrow.style.right = '36px';
                bottomArrow.style.borderWidth = '4px';
                bottomArrow.style.borderColor = 'transparent transparent transparent #64748b';
                container.appendChild(bottomArrow);
                
                // Add depth label
                const depthLabel = document.createElement('div');
                depthLabel.className = 'depth-label';
                depthLabel.textContent = `Depth: ${depth}mm`;
                depthLabel.style.top = `${(depthPercent + 15) / 2 - 10}%`;
                depthLabel.style.right = '50px';
                container.appendChild(depthLabel);
                
                // Calculate cable size based on container and make it more realistic
                const maxCableSize = Math.min(containerWidth, containerHeight) * 0.12;
                const cableDiameter = Math.min(maxCableSize, Math.sqrt(size) * 0.75); // More realistic scale
                
                // Calculate positions based on circuits and arrangement
                const positions = [];
                
                if (construction === 'singleCore') {
                    if (circuits === 1) {
                        // Single circuit
                        if (arrangement === 'trefoil') {
                            // Trefoil arrangement
                            const centerX = containerWidth / 2;
                            const centerY = depthPercent * containerHeight / 100;
                            const offset = cableDiameter * 1.2;
                            
                            positions.push(
                                { x: centerX, y: centerY - offset / 1.5, phase: 'R' },
                                { x: centerX - offset, y: centerY + offset / 2, phase: 'Y' },
                                { x: centerX + offset, y: centerY + offset / 2, phase: 'B' }
                            );
                        } else {
                            // Flat arrangement
                            const centerY = depthPercent * containerHeight / 100;
                            const offset = cableDiameter * 1.5;
                            
                            positions.push(
                                { x: containerWidth / 2 - offset, y: centerY, phase: 'R' },
                                { x: containerWidth / 2, y: centerY, phase: 'Y' },
                                { x: containerWidth / 2 + offset, y: centerY, phase: 'B' }
                            );
                        }
                    } else {
                        // Multiple circuits
                        const spacingValue = spacing === "Touching" ? 0 : parseInt(spacing);
                        const spacingPx = spacingValue === 0 ? cableDiameter * 0.1 : cableDiameter * (spacingValue / 200);
                        
                        // Calculate total width needed
                        let totalWidth;
                        if (arrangement === 'trefoil') {
                            totalWidth = (circuits * cableDiameter * 2.4) + ((circuits - 1) * spacingPx);
                        } else {
                            totalWidth = (circuits * cableDiameter * 3) + ((circuits - 1) * spacingPx);
                        }
                        
                        // Calculate starting point to center the group
                        const startX = (containerWidth - totalWidth) / 2 + cableDiameter;
                        const centerY = depthPercent * containerHeight / 100;
                        
                        for (let i = 0; i < circuits; i++) {
                            if (arrangement === 'trefoil') {
                                // Trefoil arrangement for each circuit
                                const circuitCenterX = startX + i * (cableDiameter * 2.4 + spacingPx);
                                const offset = cableDiameter * 0.7;
                                
                                positions.push(
                                    { x: circuitCenterX, y: centerY - offset, phase: 'R', circuit: i+1 },
                                    { x: circuitCenterX - offset, y: centerY + offset / 2, phase: 'Y', circuit: i+1 },
                                    { x: circuitCenterX + offset, y: centerY + offset / 2, phase: 'B', circuit: i+1 }
                                );
                                
                                // Add spacing indicator for multiple circuits
                                if (i < circuits - 1 && circuits > 1 && spacingValue > 0) {
                                    const spacingMarker = document.createElement('div');
                                    spacingMarker.className = 'spacing-marker';
                                    spacingMarker.style.left = `${circuitCenterX + offset + 5}px`;
                                    spacingMarker.style.width = `${spacingPx - 10}px`;
                                    spacingMarker.style.top = `${centerY}px`;
                                    container.appendChild(spacingMarker);
                                    
                                    // Add spacing label if there's enough room
                                    if (spacingPx > 30) {
                                        const spacingLabel = document.createElement('div');
                                        spacingLabel.className = 'depth-label';
                                        spacingLabel.textContent = `${spacing}mm`;
                                        spacingLabel.style.left = `${circuitCenterX + offset + spacingPx/2 - 15}px`;
                                        spacingLabel.style.top = `${centerY - 20}px`;
                                        container.appendChild(spacingLabel);
                                    }
                                }
                            } else {
                                // Flat arrangement for each circuit
                                const circuitCenterX = startX + i * (cableDiameter * 3 + spacingPx);
                                const offset = cableDiameter * 1.1;
                                
                                positions.push(
                                    { x: circuitCenterX - offset, y: centerY, phase: 'R', circuit: i+1 },
                                    { x: circuitCenterX, y: centerY, phase: 'Y', circuit: i+1 },
                                    { x: circuitCenterX + offset, y: centerY, phase: 'B', circuit: i+1 }
                                );
                                
                                // Add spacing indicator for multiple circuits
                                if (i < circuits - 1 && circuits > 1 && spacingValue > 0) {
                                    const spacingMarker = document.createElement('div');
                                    spacingMarker.className = 'spacing-marker';
                                    spacingMarker.style.left = `${circuitCenterX + offset + 5}px`;
                                    spacingMarker.style.width = `${spacingPx - 10}px`;
                                    spacingMarker.style.top = `${centerY}px`;
                                    container.appendChild(spacingMarker);
                                    
                                    // Add spacing label if there's enough room
                                    if (spacingPx > 30) {
                                        const spacingLabel = document.createElement('div');
                                        spacingLabel.className = 'depth-label';
                                        spacingLabel.textContent = `${spacing}mm`;
                                        spacingLabel.style.left = `${circuitCenterX + offset + spacingPx/2 - 15}px`;
                                        spacingLabel.style.top = `${centerY - 20}px`;
                                        container.appendChild(spacingLabel);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    // Three-core cable(s)
                    if (circuits === 1) {
                        // Single cable
                        positions.push({ x: containerWidth / 2, y: depthPercent * containerHeight / 100 });
                    } else {
                        // Multiple cables
                        const spacingValue = spacing === "Touching" ? 0 : parseInt(spacing);
                        const spacingPx = spacingValue === 0 ? cableDiameter * 0.1 : cableDiameter * (spacingValue / 200);
                        const totalWidth = (circuits * cableDiameter * 1.2) + ((circuits - 1) * spacingPx);
                        const startX = (containerWidth - totalWidth) / 2 + cableDiameter * 0.6;
                        const centerY = depthPercent * containerHeight / 100;
                        
                        for (let i = 0; i < circuits; i++) {
                            const cableX = startX + i * (cableDiameter * 1.2 + spacingPx);
                            positions.push({ x: cableX, y: centerY, cable: i+1 });
                            
                            // Add spacing indicator for multiple cables
                            if (i < circuits - 1 && spacingValue > 0) {
                                const spacingMarker = document.createElement('div');
                                spacingMarker.className = 'spacing-marker';
                                spacingMarker.style.left = `${cableX + cableDiameter*0.6 + 5}px`;
                                spacingMarker.style.width = `${spacingPx - 10}px`;
                                spacingMarker.style.top = `${centerY}px`;
                                container.appendChild(spacingMarker);
                                
                                // Add spacing label if there's enough room
                                if (spacingPx > 30) {
                                    const spacingLabel = document.createElement('div');
                                    spacingLabel.className = 'depth-label';
                                    spacingLabel.textContent = `${spacing}mm`;
                                    spacingLabel.style.left = `${cableX + cableDiameter*0.6 + spacingPx/2 - 15}px`;
                                    spacingLabel.style.top = `${centerY - 20}px`;
                                    container.appendChild(spacingLabel);
                                }
                            }
                        }
                    }
                }
                
                // Create cables
                for (const pos of positions) {
                    const cable = document.createElement('div');
                    
                    if (construction === 'singleCore') {
                        cable.className = `cable-cross-section cable-single-core cable-conductor-${material}`;
                    } else {
                        cable.className = `cable-cross-section cable-three-core cable-conductor-${material}`;
                    }
                    
                    cable.style.width = `${cableDiameter}px`;
                    cable.style.height = `${cableDiameter}px`;
                    cable.style.left = `${pos.x - cableDiameter/2}px`;
                    cable.style.top = `${pos.y - cableDiameter/2}px`;
                    cable.style.position = 'absolute';
                    
                    // Add duct if in ducts
                    if (installation === 'inDucts') {
                        const duct = document.createElement('div');
                        duct.className = 'cable-in-duct';
                        duct.style.width = `${cableDiameter * 1.5}px`;
                        duct.style.height = `${cableDiameter * 1.5}px`;
                        duct.style.position = 'absolute';
                        duct.style.left = `${pos.x - cableDiameter*1.5/2}px`;
                        duct.style.top = `${pos.y - cableDiameter*1.5/2}px`;
                        container.appendChild(duct);
                    }
                    
                    // Add phase indicator for single-core cables
                    if (construction === 'singleCore' && pos.phase) {
                        const phaseLabel = document.createElement('div');
                        phaseLabel.style.position = 'absolute';
                        phaseLabel.style.top = '50%';
                        phaseLabel.style.left = '50%';
                        phaseLabel.style.transform = 'translate(-50%, -50%)';
                        phaseLabel.style.color = 'white';
                        phaseLabel.style.fontWeight = 'bold';
                        phaseLabel.style.fontSize = '10px';
                        phaseLabel.style.textShadow = '0 0 2px black';
                        phaseLabel.textContent = pos.phase;
                        
                        // If more than one circuit, add circuit number
                        if (pos.circuit && circuits > 1) {
                            phaseLabel.textContent += pos.circuit;
                        }
                        
                        cable.appendChild(phaseLabel);
                    }
                    
                    // Add cable number for three-core cables if more than one circuit
                    if (construction === 'threeCore' && pos.cable && circuits > 1) {
                        const cableLabel = document.createElement('div');
                        cableLabel.style.position = 'absolute';
                        cableLabel.style.top = '50%';
                        cableLabel.style.left = '50%';
                        cableLabel.style.transform = 'translate(-50%, -50%)';
                        cableLabel.style.color = 'white';
                        cableLabel.style.fontWeight = 'bold';
                        cableLabel.style.fontSize = '10px';
                        cableLabel.style.textShadow = '0 0 2px black';
                        cableLabel.textContent = pos.cable;
                        cable.appendChild(cableLabel);
                    }
                    
                    container.appendChild(cable);
                }
                
                // Draw legend
                if (installation === 'inDucts') {
                    const legend = document.createElement('div');
                    legend.style.position = 'absolute';
                    legend.style.bottom = '40px';
                    legend.style.right = '10px';
                    legend.style.background = 'rgba(255,255,255,0.7)';
                    legend.style.padding = '5px';
                    legend.style.borderRadius = '3px';
                    legend.style.fontSize = '10px';
                    legend.style.color = '#1f2937';
                    legend.textContent = 'Cables in Ducts';
                    container.appendChild(legend);
                }
            }
            
            // Render cables in air
            function renderAirCables(params) {
                const {
                    container,
                    material,
                    construction,
                    size,
                    airMethod,
                    airArrangement,
                    circuits,
                    trays,
                    containerWidth,
                    containerHeight
                } = params;
                
                // Calculate cable size based on container
                const maxCableSize = Math.min(containerWidth / (circuits * 3), containerHeight / (trays * 2)) * 0.7;
                const cableDiameter = Math.min(maxCableSize, Math.sqrt(size) * 0.75); // More realistic scale
                
                // Draw trays
                const trayHeight = containerHeight / (trays + 1);
                const trayMargin = trayHeight / 2;
                
                for (let t = 0; t < trays; t++) {
                    const trayY = trayMargin + t * trayHeight;
                    
                    // Create tray label
                    const trayLabel = document.createElement('div');
                    trayLabel.className = 'depth-label';
                    trayLabel.textContent = `Tray ${t+1}`;
                    trayLabel.style.left = '10px';
                    trayLabel.style.top = `${trayY - 20}px`;
                    container.appendChild(trayLabel);
                    
                    // Create tray
                    const tray = document.createElement('div');
                    tray.className = 'cable-tray';
                    tray.style.position = 'absolute';
                    tray.style.left = '10%';
                    tray.style.width = '80%';
                    tray.style.height = '10px';
                    tray.style.top = `${trayY}px`;
                    
                    if (airMethod === 'verticalTrays') {
                        // Vertical tray orientation
                        tray.style.width = '10px';
                        tray.style.height = '70%';
                        tray.style.left = `${(containerWidth / 2) - 5}px`;
                        tray.style.top = '15%';
                        
                        // Update label position
                        trayLabel.style.left = `${containerWidth/2 + 10}px`;
                        trayLabel.style.top = '10px';
                    } else if (airMethod === 'ladderSupports') {
                        // Ladder style - add some rungs
                        tray.style.height = '10px';
                        tray.style.background = 'repeating-linear-gradient(90deg, #9ca3af, #9ca3af 10px, transparent 10px, transparent 30px)';
                    }
                    
                    container.appendChild(tray);
                    
                    // Place cables on tray
                    const cablesPerTray = Math.ceil(circuits / trays);
                    const cableStartX = containerWidth * 0.15;
                    const cableSpacing = (containerWidth * 0.7) / (cablesPerTray + 1);
                    
                    for (let c = 0; c < cablesPerTray; c++) {
                        const circuitIndex = t * cablesPerTray + c;
                        if (circuitIndex >= circuits) break; // Don't create more than specified circuits
                        
                        const cableX = cableStartX + (c + 1) * cableSpacing;
                        
                        if (construction === 'singleCore') {
                            // Single core with trefoil or flat arrangement
                            if (airArrangement === 'trefoil') {
                                // Trefoil arrangement
                                const offset = cableDiameter * 0.7;
                                
                                createCable({
                                    container,
                                    x: cableX, 
                                    y: trayY - offset, 
                                    diameter: cableDiameter, 
                                    material, 
                                    construction,
                                    label: 'R' + (circuits > trays ? (circuitIndex + 1) : '')
                                });
                                
                                createCable({
                                    container,
                                    x: cableX - offset, 
                                    y: trayY + offset / 2, 
                                    diameter: cableDiameter, 
                                    material, 
                                    construction,
                                    label: 'Y' + (circuits > trays ? (circuitIndex + 1) : '')
                                });
                                
                                createCable({
                                    container,
                                    x: cableX + offset, 
                                    y: trayY + offset / 2, 
                                    diameter: cableDiameter, 
                                    material, 
                                    construction,
                                    label: 'B' + (circuits > trays ? (circuitIndex + 1) : '')
                                });
                            } else {
                                // Flat arrangement
                                const offset = cableDiameter * 1.1;
                                
                                createCable({
                                    container, 
                                    x: cableX - offset, 
                                    y: trayY - cableDiameter/2, 
                                    diameter: cableDiameter, 
                                    material, 
                                    construction,
                                    label: 'R' + (circuits > trays ? (circuitIndex + 1) : '')
                                });
                                
                                createCable({
                                    container, 
                                    x: cableX, 
                                    y: trayY - cableDiameter/2, 
                                    diameter: cableDiameter, 
                                    material, 
                                    construction,
                                    label: 'Y' + (circuits > trays ? (circuitIndex + 1) : '')
                                });
                                
                                createCable({
                                    container, 
                                    x: cableX + offset, 
                                    y: trayY - cableDiameter/2, 
                                    diameter: cableDiameter, 
                                    material, 
                                    construction,
                                    label: 'B' + (circuits > trays ? (circuitIndex + 1) : '')
                                });
                            }
                        } else {
                            // Three-core cable
                            if (airMethod === 'verticalTrays') {
                                // On vertical tray
                                createCable({
                                    container, 
                                    x: containerWidth / 2 + cableDiameter, 
                                    y: trayY + c * (cableDiameter * 1.5), 
                                    diameter: cableDiameter * 1.4, 
                                    material, 
                                    construction,
                                    label: circuits > 1 ? (circuitIndex + 1).toString() : ''
                                });
                            } else {
                                // On horizontal tray
                                createCable({
                                    container, 
                                    x: cableX, 
                                    y: trayY - cableDiameter*0.7, 
                                    diameter: cableDiameter * 1.4, 
                                    material, 
                                    construction,
                                    label: circuits > 1 ? (circuitIndex + 1).toString() : ''
                                });
                            }
                        }
                    }
                }
                
                // Add installation method legend
                const legend = document.createElement('div');
                legend.style.position = 'absolute';
                legend.style.bottom = '40px';
                legend.style.right = '10px';
                legend.style.background = 'rgba(255,255,255,0.7)';
                legend.style.padding = '5px';
                legend.style.borderRadius = '3px';
                legend.style.fontSize = '10px';
                legend.style.color = '#1f2937';
                
                if (airMethod === 'perforatedTrays') {
                    legend.textContent = 'Cables on Perforated Trays';
                } else if (airMethod === 'ladderSupports') {
                    legend.textContent = 'Cables on Ladder Supports';
                } else {
                    legend.textContent = 'Cables on Vertical Trays';
                }
                
                container.appendChild(legend);
            }
            
            // Helper function to create a cable element
            function createCable({container, x, y, diameter, material, construction, label}) {
                const cable = document.createElement('div');
                
                if (construction === 'singleCore') {
                    cable.className = `cable-cross-section cable-single-core cable-conductor-${material}`;
                } else {
                    cable.className = `cable-cross-section cable-three-core cable-conductor-${material}`;
                }
                
                cable.style.width = `${diameter}px`;
                cable.style.height = `${diameter}px`;
                cable.style.left = `${x - diameter/2}px`;
                cable.style.top = `${y - diameter/2}px`;
                cable.style.position = 'absolute';
                
                // Add label to cable if provided
                if (label) {
                    const cableLabel = document.createElement('div');
                    cableLabel.style.position = 'absolute';
                    cableLabel.style.top = '50%';
                    cableLabel.style.left = '50%';
                    cableLabel.style.transform = 'translate(-50%, -50%)';
                    cableLabel.style.color = 'white';
                    cableLabel.style.fontWeight = 'bold';
                    cableLabel.style.fontSize = '10px';
                    cableLabel.style.textShadow = '0 0 2px black';
                    cableLabel.textContent = label;
                    cable.appendChild(cableLabel);
                }
                
                container.appendChild(cable);
                return cable;
            }

            // Calculate the current rating
            function calculateCurrentRating() {
                console.log("Starting calculation with enhanced features...");
                
                // Get all selected values (existing code)
                const material = conductorMaterial.value;
                const construction = cableConstruction.value;
                const voltage = voltageRating.value;
                const size = parseInt(conductorSize.value);
                const installation = installationType.value;
                const temp = parseInt(temperature.value);
                const depth = parseInt(depthOfLaying.value);
                const resistivity = parseFloat(thermalResistivity.value);
                const circuits = parseInt(numberOfCircuits.value);
                const spacing = cableSpacing.value;
                const trays = parseInt(numberOfTrays.value);
                
                // Get user requirements
                const requiredCurrent = parseFloat(document.getElementById('requiredCurrent').value) || 0;
                const cableLength = parseFloat(document.getElementById('cableLength').value) || 100;
                const supplyVoltage = parseFloat(document.getElementById('supplyVoltage').value) || 0;
                const maxVoltageDrop = parseFloat(document.getElementById('maxVoltageDrop').value) || 5;
                const shortCircuitCurrent = parseFloat(document.getElementById('shortCircuitCurrent').value) || 0;
                const faultDuration = parseFloat(document.getElementById('faultDuration').value) || 1;
                
                console.log("Selected values:", { material, construction, voltage, size, installation, 
                    temp, depth, resistivity, circuits, spacing, trays });
                
                // --- 1. Get Base Current Rating ---
                let baseRatingArray; // This will be an array of ratings for different sizes
                const cableType = material === 'copper' ? 
                    (construction === 'singleCore' ? 'singleCoreCopper' : 'threeCoreCopper') :
                    (construction === 'singleCore' ? 'singleCoreAluminum' : 'threeCoreAluminum');

                const voltageSpecificData = cableData[cableType]?.[voltage];

                if (!voltageSpecificData) {
                    console.error(`Base rating data not found for cableType: ${cableType}, voltage: ${voltage}`);
                    alert("Error: Base rating data not found. Please check cable data or selections.");
                    return;
                }

                if (construction === 'singleCore') {
                    const arrangement = installation === 'inAir' ? airArrangement.value : cableArrangement.value;
                    if (installation === 'inAir') {
                        // For inAir singleCore, arrangement is 'trefoil' or 'flat'. Data uses 'trefoil' or 'flatTouching'.
                        const airArrangementKey = arrangement === 'flat' ? 'flatTouching' : arrangement;
                        baseRatingArray = voltageSpecificData.inAir?.[airArrangementKey];
                    } else { // buriedDirect or inDucts
                        baseRatingArray = voltageSpecificData[installation]?.[arrangement];
                    }
                } else { // Three-core cable
                    baseRatingArray = voltageSpecificData[installation];
                }

                if (!baseRatingArray) {
                    console.error(`Base rating array not found. Material: ${material}, Construction: ${construction}, Voltage: ${voltage}, Installation: ${installation}, Arrangement: ${construction === 'singleCore' ? (installation === 'inAir' ? airArrangement.value : cableArrangement.value) : 'N/A'}`);
                    alert("Error: Could not determine base rating array. Please check selections or cable data.");
                    return;
                }
                
                const sizesArray = construction === 'singleCore' ? 
                    cableData.conductorSizes.singleCore : 
                    cableData.conductorSizes.threeCore;
                const sizeIndex = sizesArray.indexOf(size);
                
                if (sizeIndex === -1) {
                    console.error(`Conductor size ${size}mm² not found in sizesArray: [${sizesArray.join(', ')}] for ${construction}.`);
                    alert(`Error: Conductor size ${size}mm² not found for the selected cable construction.`);
                    return;
                }
                
                const numericBaseRating = baseRatingArray[sizeIndex];
                if (typeof numericBaseRating === 'undefined') {
                    console.error(`Base rating value is undefined for sizeIndex ${sizeIndex}. BaseRatingArray: [${baseRatingArray.join(', ')}]`);
                    alert("Error: Could not find base rating for the selected conductor size.");
                    return;
                }

                // --- 2. Get Temperature Derating Factor ---
                let tempFactor = 1.0;
                let tempDataSource;
                if (installation === 'inAir') {
                    tempDataSource = cableData.temperatureFactors.air;
                } else if (installation === 'inDucts') {
                    tempDataSource = cableData.temperatureFactors.ducts;
                } else { // 'buriedDirect'
                    tempDataSource = cableData.temperatureFactors.ground;
                }

                if (tempDataSource && tempDataSource.temperatures && tempDataSource.factors) {
                    // Check for exact temperature match
                    const tempIndex = tempDataSource.temperatures.indexOf(temp);
                    if (tempIndex !== -1) {
                        tempFactor = tempDataSource.factors[tempIndex];
                    } else {
                        // Temperature not found - use interpolation
                        let lowerIndex = -1;
                        let upperIndex = -1;
                        
                        // Find closest temperature values
                        for (let i = 0; i < tempDataSource.temperatures.length; i++) {
                            if (tempDataSource.temperatures[i] <= temp && 
                                (lowerIndex === -1 || tempDataSource.temperatures[i] > tempDataSource.temperatures[lowerIndex])) {
                                lowerIndex = i;
                            }
                            if (tempDataSource.temperatures[i] >= temp && 
                                (upperIndex === -1 || tempDataSource.temperatures[i] < tempDataSource.temperatures[upperIndex])) {
                                upperIndex = i;
                            }
                        }
                        
                        if (lowerIndex !== -1 && upperIndex !== -1 && lowerIndex !== upperIndex) {
                            // Interpolate
                            const lowerTemp = tempDataSource.temperatures[lowerIndex];
                            const upperTemp = tempDataSource.temperatures[upperIndex];
                            const fraction = (temp - lowerTemp) / (upperTemp - lowerTemp);
                            const lowerFactor = tempDataSource.factors[lowerIndex];
                            const upperFactor = tempDataSource.factors[upperIndex];
                            tempFactor = lowerFactor + fraction * (upperFactor - lowerFactor);
                            console.log(`Interpolated temperature factor between ${lowerTemp}°C (${lowerFactor}) and ${upperTemp}°C (${upperFactor}): ${tempFactor}`);
                        } else if (lowerIndex !== -1) {
                            tempFactor = tempDataSource.factors[lowerIndex];
                            console.log(`Using nearest lower temperature factor for ${temp}°C: ${tempFactor}`);
                        } else if (upperIndex !== -1) {
                            tempFactor = tempDataSource.factors[upperIndex];
                            console.log(`Using nearest upper temperature factor for ${temp}°C: ${tempFactor}`);
                        } else {
                            console.warn(`Temperature ${temp}°C not found and no nearby values. Available: [${tempDataSource.temperatures.join(', ')}]. Using factor 1.0.`);
                        }
                    }
                } else {
                    console.error(`Temperature factor data source not found or incomplete for installation: ${installation}. Using factor 1.0.`);
                }
                
                // --- 3. Get Depth Derating Factor ---
                let depthFactor = 1.0;
                if (installation !== 'inAir') {
                    // Get correct voltage range mapping from voltage string
                    let voltageRange;
                    if (voltage.includes('22') || voltage.includes('33')) {
                        voltageRange = '22-33kV';
                    } else if (voltage.includes('3.3') || voltage.includes('6.6') || voltage.includes('11')) {
                        voltageRange = '3.3-11kV';
                    } else {
                        voltageRange = '3.3-11kV'; // default
                        console.warn(`Unknown voltage range for ${voltage}, using default '3.3-11kV'`);
                    }
                    
                    console.log(`Using voltage range: ${voltageRange} for depth factor`);
                    
                    const depthFactorSource = cableData.depthFactors?.[installation]?.[voltageRange];
                    
                    if (depthFactorSource && depthFactorSource.depths) {
                        // Check for exact depth match
                        const depthIndex = depthFactorSource.depths.indexOf(depth);
                        if (depthIndex !== -1) {
                            if (construction === 'singleCore') {
                                const sizeCategory = size <= 185 ? '≤185' : '>185';
                                if (depthFactorSource.singleCore?.[sizeCategory]?.[depthIndex] !== undefined) {
                                    depthFactor = depthFactorSource.singleCore[sizeCategory][depthIndex];
                                } else {
                                    console.warn(`Depth factor for singleCore, size ${sizeCategory}, depthIndex ${depthIndex} not found. Using 1.0.`);
                                }
                            } else { // threeCore
                                if (depthFactorSource.threeCore?.[depthIndex] !== undefined) {
                                    depthFactor = depthFactorSource.threeCore[depthIndex];
                                } else {
                                    console.warn(`Depth factor for threeCore, depthIndex ${depthIndex} not found. Using 1.0.`);
                                }
                            }
                        } else {
                            // Depth not found - use interpolation
                            let lowerIndex = -1;
                            let upperIndex = -1;
                            
                            // Find closest depth values
                            for (let i = 0; i < depthFactorSource.depths.length; i++) {
                                if (depthFactorSource.depths[i] <= depth && 
                                    (lowerIndex === -1 || depthFactorSource.depths[i] > depthFactorSource.depths[lowerIndex])) {
                                    lowerIndex = i;
                                }
                                if (depthFactorSource.depths[i] >= depth && 
                                    (upperIndex === -1 || depthFactorSource.depths[i] < depthFactorSource.depths[upperIndex])) {
                                    upperIndex = i;
                                }
                            }
                            
                            if (lowerIndex !== -1 && upperIndex !== -1 && lowerIndex !== upperIndex) {
                                // Interpolate
                                const lowerDepth = depthFactorSource.depths[lowerIndex];
                                const upperDepth = depthFactorSource.depths[upperIndex];
                                const fraction = (depth - lowerDepth) / (upperDepth - lowerDepth);
                                
                                if (construction === 'singleCore') {
                                    const sizeCategory = size <= 185 ? '≤185' : '>185';
                                    const lowerFactor = depthFactorSource.singleCore[sizeCategory][lowerIndex];
                                    const upperFactor = depthFactorSource.singleCore[sizeCategory][upperIndex];
                                    depthFactor = lowerFactor + fraction * (upperFactor - lowerFactor);
                                    console.log(`Interpolated depth factor for ${construction} ${sizeCategory} between ${lowerDepth}mm (${lowerFactor}) and ${upperDepth}mm (${upperFactor}): ${depthFactor}`);
                                } else { // threeCore
                                    const lowerFactor = depthFactorSource.threeCore[lowerIndex];
                                    const upperFactor = depthFactorSource.threeCore[upperIndex];
                                    depthFactor = lowerFactor + fraction * (upperFactor - lowerFactor);
                                    console.log(`Interpolated depth factor for ${construction} between ${lowerDepth}mm (${lowerFactor}) and ${upperDepth}mm (${upperFactor}): ${depthFactor}`);
                                }
                            } else if (lowerIndex !== -1) {
                                // Use the lower value
                                if (construction === 'singleCore') {
                                    const sizeCategory = size <= 185 ? '≤185' : '>185';
                                    depthFactor = depthFactorSource.singleCore[sizeCategory][lowerIndex];
                                } else {
                                    depthFactor = depthFactorSource.threeCore[lowerIndex];
                                }
                                console.log(`Using nearest lower depth factor for ${depth}mm: ${depthFactor}`);
                            } else if (upperIndex !== -1) {
                                // Use the upper value
                                if (construction === 'singleCore') {
                                    const sizeCategory = size <= 185 ? '≤185' : '>185';
                                    depthFactor = depthFactorSource.singleCore[sizeCategory][upperIndex];
                                } else {
                                    depthFactor = depthFactorSource.threeCore[upperIndex];
                                }
                                console.log(`Using nearest upper depth factor for ${depth}mm: ${depthFactor}`);
                            } else {
                                console.warn(`Depth ${depth}mm not found in depth factor data for ${installation}, ${voltageRange}. Available: [${depthFactorSource.depths.join(', ')}]. Using factor 1.0.`);
                            }
                        }
                    } else {
                        console.error(`Depth factor data source not found for ${installation}, ${voltageRange}. Using factor 1.0.`);
                    }
                }
                
                // --- 4. Get Thermal Resistivity Factor ---
                let resistivityFactor = 1.0;
                if (installation !== 'inAir') {
                    // Get correct voltage range mapping from voltage string
                    let voltageRange;
                    if (voltage.includes('22') || voltage.includes('33')) {
                        voltageRange = '22-33kV';
                    } else if (voltage.includes('3.3') || voltage.includes('6.6') || voltage.includes('11')) {
                        voltageRange = '3.3-11kV';
                    } else {
                        voltageRange = '3.3-11kV'; // default
                        console.warn(`Unknown voltage range for ${voltage}, using default '3.3-11kV'`);
                    }
                    
                    console.log(`Using voltage range: ${voltageRange} for resistivity factor`);
                    
                    const resFactorDataSource = cableData.thermalResistivityFactors?.[construction]?.[voltageRange]?.[installation];
                    
                    if (resFactorDataSource && resFactorDataSource.resistivities && resFactorDataSource.factors) {
                        // Find the closest resistivity values and interpolate if necessary
                        const resistivities = resFactorDataSource.resistivities;
                        let resIndex = resistivities.indexOf(resistivity);
                        
                        if (resIndex === -1) {
                            // Resistivity not found exactly - find closest values for interpolation
                            let lowerIndex = -1;
                            let upperIndex = -1;
                            
                            for (let i = 0; i < resistivities.length; i++) {
                                if (resistivities[i] <= resistivity && (lowerIndex === -1 || resistivities[i] > resistivities[lowerIndex])) {
                                    lowerIndex = i;
                                }
                                if (resistivities[i] >= resistivity && (upperIndex === -1 || resistivities[i] < resistivities[upperIndex])) {
                                    upperIndex = i;
                                }
                            }
                            
                            if (lowerIndex !== -1 && upperIndex !== -1 && lowerIndex !== upperIndex) {
                                // Interpolate between lower and upper values
                                const lowerRes = resistivities[lowerIndex];
                                const upperRes = resistivities[upperIndex];
                                const fraction = (resistivity - lowerRes) / (upperRes - lowerRes);
                                
                                if (resFactorDataSource.factors[sizeIndex]) {
                                    const lowerFactor = resFactorDataSource.factors[sizeIndex][lowerIndex];
                                    const upperFactor = resFactorDataSource.factors[sizeIndex][upperIndex];
                                    resistivityFactor = lowerFactor + fraction * (upperFactor - lowerFactor);
                                    console.log(`Interpolated resistivity factor between ${lowerRes} K.m/W (${lowerFactor}) and ${upperRes} K.m/W (${upperFactor}): ${resistivityFactor}`);
                                } else {
                                    console.warn(`Resistivity factor array for sizeIndex ${sizeIndex} not found. Using default 1.0.`);
                                }
                            } else if (lowerIndex !== -1) {
                                // Use the lower value
                                resistivityFactor = resFactorDataSource.factors[sizeIndex]?.[lowerIndex] || 1.0;
                                console.log(`Using lower resistivity factor for ${resistivity} K.m/W: ${resistivityFactor}`);
                            } else if (upperIndex !== -1) {
                                // Use the upper value
                                resistivityFactor = resFactorDataSource.factors[sizeIndex]?.[upperIndex] || 1.0;
                                console.log(`Using upper resistivity factor for ${resistivity} K.m/W: ${resistivityFactor}`);
                            } else {
                                console.warn(`No applicable resistivity found for ${resistivity} K.m/W. Available: [${resistivities.join(', ')}]. Using factor 1.0.`);
                            }
                        } else {
                            // Exact resistivity value found
                            if (resFactorDataSource.factors[sizeIndex]?.[resIndex] !== undefined) {
                                resistivityFactor = resFactorDataSource.factors[sizeIndex][resIndex];
                                console.log(`Exact resistivity factor found for ${resistivity} K.m/W: ${resistivityFactor}`);
                            } else {
                                console.warn(`Resistivity factor for sizeIndex ${sizeIndex}, resIndex ${resIndex} not found. Using 1.0.`);
                            }
                        }
                    } else {
                        console.error(`Thermal resistivity factor data source not found for ${construction}, ${voltageRange}, ${installation}. Using factor 1.0.`);
                    }
                }
                
                // --- 5. Get Grouping Factor ---
                let groupingFactor = 1.0;
                if (circuits > 1) {
                    if (installation === 'inAir') {
                        const airMethod = airInstallationMethod.value;
                        const arrangement = airArrangement.value; // 'trefoil' or 'flat'
                        let groupingDataSource;

                        if (construction === 'singleCore') {
                            if (airMethod === 'verticalTrays' && arrangement === 'trefoil') {
                                groupingDataSource = cableData.groupingFactors.singleCore.inAirVerticalTrefoil;
                            } else if (arrangement === 'trefoil') { // Horizontal trefoil
                                groupingDataSource = cableData.groupingFactors.singleCore.inAirTrefoil;
                            } else { // Flat arrangement
                                groupingDataSource = cableData.groupingFactors.singleCore.inAirFlat;
                            }
                        } else { // Three-core in air
                            if (airMethod === 'verticalTrays') {
                                groupingDataSource = cableData.groupingFactors.threeCore.inAirVertical;
                            } else if (airMethod === 'ladderSupports') {
                                groupingDataSource = cableData.groupingFactors.threeCore.inAirLadder;
                            } else { // 'perforatedTrays' maps to 'inAirHorizontal'
                                groupingDataSource = cableData.groupingFactors.threeCore.inAirHorizontal;
                            }
                        }

                        if (groupingDataSource && groupingDataSource.trays && groupingDataSource.factors) {
                            const trayIndex = groupingDataSource.trays.indexOf(trays);
                            // Key for number of items is 'circuits' for singleCore, 'cables' for threeCore in some data structures
                            const numberKeyArray = groupingDataSource.circuits || groupingDataSource.cables;
                            
                            // Exact match or interpolate the circuits/cables
                            let numberIndex = numberKeyArray ? numberKeyArray.indexOf(circuits) : -1;
                            let numberFactor = 1.0;
                            
                            if (numberIndex === -1 && numberKeyArray) {
                                // Find closest values for interpolation
                                let lowerIndex = -1;
                                let upperIndex = -1;
                                
                                for (let i = 0; i < numberKeyArray.length; i++) {
                                    if (numberKeyArray[i] <= circuits && (lowerIndex === -1 || numberKeyArray[i] > numberKeyArray[lowerIndex])) {
                                        lowerIndex = i;
                                    }
                                    if (numberKeyArray[i] >= circuits && (upperIndex === -1 || numberKeyArray[i] < numberKeyArray[upperIndex])) {
                                        upperIndex = i;
                                    }
                                }
                                
                                if (lowerIndex !== -1 && upperIndex !== -1 && lowerIndex !== upperIndex) {
                                    // Interpolate for number of circuits/cables
                                    const lowerNumber = numberKeyArray[lowerIndex];
                                    const upperNumber = numberKeyArray[upperIndex];
                                    const fraction = (circuits - lowerNumber) / (upperNumber - lowerNumber);
                                    
                                    if (trayIndex !== -1 && groupingDataSource.factors[trayIndex]) {
                                        const lowerFactor = groupingDataSource.factors[trayIndex][lowerIndex];
                                        const upperFactor = groupingDataSource.factors[trayIndex][upperIndex];
                                        numberFactor = lowerFactor + fraction * (upperFactor - lowerFactor);
                                    }
                                } else if (lowerIndex !== -1 && trayIndex !== -1) {
                                    numberFactor = groupingDataSource.factors[trayIndex][lowerIndex];
                                } else if (upperIndex !== -1 && trayIndex !== -1) {
                                    numberFactor = groupingDataSource.factors[trayIndex][upperIndex];
                                }
                                
                                groupingFactor = numberFactor;
                                console.log(`Interpolated grouping factor for ${circuits} circuits/cables: ${groupingFactor}`);
                            } else if (trayIndex !== -1 && numberIndex !== -1 && groupingDataSource.factors[trayIndex]?.[numberIndex] !== undefined) {
                                groupingFactor = groupingDataSource.factors[trayIndex][numberIndex];
                                console.log(`Exact grouping factor found: ${groupingFactor}`);
                            } else {
                                console.warn(`Grouping factor not found for in-air. Construction: ${construction}, Method: ${airMethod}, Arrangement: ${arrangement}, Trays: ${trays}, Circuits/Cables: ${circuits}. Using 1.0.`);
                                if(trayIndex === -1) console.warn(`Available trays: [${groupingDataSource.trays.join(', ')}]`);
                                if(numberIndex === -1 && numberKeyArray) console.warn(`Available circuits/cables: [${numberKeyArray.join(', ')}]`);
                            }
                        } else {
                            console.error(`Grouping factor data source not found for in-air ${construction}. Using factor 1.0.`);
                        }

                    } else { // Buried or in ducts grouping factors
                        const groupingDataSource = cableData.groupingFactors?.[construction]?.[installation];
                        
                        if (groupingDataSource && groupingDataSource.spacing && groupingDataSource.factors) {
                            // Handle 'spacing' which is a string "Touching" or a number in mm that needs to be converted to m
                            let mappedSpacingValue;
                            if (spacing === "Touching") {
                                mappedSpacingValue = "Touching";
                            } else if (!isNaN(parseInt(spacing))) {
                                mappedSpacingValue = parseInt(spacing) / 1000; // Convert mm string to number in meters
                            } else {
                                console.warn(`Invalid spacing value: ${spacing}. Using factor 1.0 for grouping.`);
                                mappedSpacingValue = undefined; // Will cause indexOf to be -1
                            }
                            
                            const spacingIndex = mappedSpacingValue !== undefined ? groupingDataSource.spacing.indexOf(mappedSpacingValue) : -1;
                            const numberKeyArray = groupingDataSource.circuits || groupingDataSource.cables;
                            
                            // Exact match or interpolate the circuits/cables
                            let numberIndex = numberKeyArray ? numberKeyArray.indexOf(circuits) : -1;
                            let numberFactor = 1.0;
                            
                            if (numberIndex === -1 && numberKeyArray && spacingIndex !== -1) {
                                // Find closest values for interpolation
                                let lowerIndex = -1;
                                let upperIndex = -1;
                                
                                for (let i = 0; i < numberKeyArray.length; i++) {
                                    if (numberKeyArray[i] <= circuits && (lowerIndex === -1 || numberKeyArray[i] > numberKeyArray[lowerIndex])) {
                                        lowerIndex = i;
                                    }
                                    if (numberKeyArray[i] >= circuits && (upperIndex === -1 || numberKeyArray[i] < numberKeyArray[upperIndex])) {
                                        upperIndex = i;
                                    }
                                }
                                
                                if (lowerIndex !== -1 && upperIndex !== -1 && lowerIndex !== upperIndex) {
                                    // Interpolate for number of circuits/cables
                                    const lowerNumber = numberKeyArray[lowerIndex];
                                    const upperNumber = numberKeyArray[upperIndex];
                                    const fraction = (circuits - lowerNumber) / (upperNumber - lowerNumber);
                                    
                                    const lowerFactor = groupingDataSource.factors[lowerIndex][spacingIndex];
                                    const upperFactor = groupingDataSource.factors[upperIndex][spacingIndex];
                                    numberFactor = lowerFactor + fraction * (upperFactor - lowerFactor);
                                    
                                    console.log(`Interpolated grouping factor between ${lowerNumber} and ${upperNumber} circuits/cables: ${numberFactor}`);
                                } else if (lowerIndex !== -1) {
                                    numberFactor = groupingDataSource.factors[lowerIndex][spacingIndex];
                                    console.log(`Using lower grouping factor for ${circuits} circuits/cables: ${numberFactor}`);
                                } else if (upperIndex !== -1) {
                                    numberFactor = groupingDataSource.factors[upperIndex][spacingIndex];
                                    console.log(`Using upper grouping factor for ${circuits} circuits/cables: ${numberFactor}`);
                                }
                                
                                groupingFactor = numberFactor;
                            } else if (numberIndex !== -1 && spacingIndex !== -1 && groupingDataSource.factors[numberIndex]?.[spacingIndex] !== undefined) {
                                groupingFactor = groupingDataSource.factors[numberIndex][spacingIndex];
                                console.log(`Exact grouping factor found: ${groupingFactor}`);
                            } else {
                                console.warn(`Grouping factor not found for ${installation} ${construction}. Circuits/Cables: ${circuits}, Spacing: ${spacing} (mapped to ${mappedSpacingValue}). Using 1.0.`);
                                if(numberIndex === -1 && numberKeyArray) console.warn(`Available circuits/cables: [${numberKeyArray.join(', ')}]`);
                                if(spacingIndex === -1) console.warn(`Available spacing: [${groupingDataSource.spacing.join(', ')}]`);
                            }
                        } else {
                            console.error(`Grouping factor data source not found for ${installation} ${construction}. Using factor 1.0.`);
                        }
                    }
                } else {
                    // For single circuit/cable, the grouping factor is always 1.0
                    groupingFactor = 1.0;
                }
                
                // Calculate total derating factor - use precise decimal calculation
                // Convert all factors to 5 decimal places for multiplication
                const decimalTemp = Math.round(tempFactor * 100000) / 100000;
                const decimalDepth = Math.round(depthFactor * 100000) / 100000;
                const decimalRes = Math.round(resistivityFactor * 100000) / 100000;
                const decimalGrouping = Math.round(groupingFactor * 100000) / 100000;
                
                // Multiply with higher precision to avoid floating point errors
                const totalFactor = decimalTemp * decimalDepth * decimalRes * decimalGrouping;
                const roundedTotalFactor = Math.round(totalFactor * 1000) / 1000; // Round to 3 decimals for display
                
                // Calculate final current rating
                const finalRating = Math.round(numericBaseRating * totalFactor);
                
                console.log("Calculation complete with factors:", { 
                    "Base Rating": numericBaseRating,
                    "Temperature Factor": decimalTemp, 
                    "Depth Factor": decimalDepth, 
                    "Resistivity Factor": decimalRes, 
                    "Grouping Factor": decimalGrouping,
                    "Total Factor": roundedTotalFactor,
                    "Final Rating": finalRating
                });

                // Display results
                displayResults(
                    numericBaseRating, // Use the numeric value
                    finalRating,
                    tempFactor,
                    depthFactor,
                    resistivityFactor,
                    groupingFactor,
                    roundedTotalFactor,
                    material,
                    construction,
                    voltage,
                    size,
                    installation
                );
            }
            
            // Display calculation results
            function displayResults(
                baseRating, 
                finalRating, 
                tempFactor, 
                depthFactor, 
                resistivityFactor, 
                groupingFactor, 
                totalFactor,
                material,
                construction,
                voltage,
                size,
                installation
            ) {
                // Show results section
                resultsSection.classList.remove('hidden');
                
                // Base rating description
                const materialName = material === 'copper' ? 'Copper' : 'Aluminum';
                const constructionName = construction === 'singleCore' ? 'Single-Core' : 'Three-Core';
                let installationDesc;
                
                if (installation === 'inAir') {
                    const method = airInstallationMethod.value === 'perforatedTrays' ? 'Perforated Trays' : 
                                  airInstallationMethod.value === 'ladderSupports' ? 'Ladder Supports' : 'Vertical Trays';
                    const arrangement = airArrangement.value === 'trefoil' ? 'Trefoil' : 'Flat';
                    installationDesc = `In Air (${method}, ${arrangement})`;
                } else {
                    const location = installation === 'buriedDirect' ? 'Buried Direct in Ground' : 'In Ducts';
                    const arrangement = cableArrangement.value === 'trefoil' ? 'Trefoil' : 'Flat Touching';
                    installationDesc = construction === 'singleCore' ? 
                        `${location} (${arrangement})` : 
                        location;
                }
                
                baseRatingDesc.textContent = `${materialName} ${constructionName}, ${voltage}, ${size} mm², ${installationDesc}`;
                baseRatingValue.textContent = `${baseRating} A`;
                
                // Derating factors
                temperatureFactorValue.textContent = tempFactor.toFixed(2);
                
                if (installation !== 'inAir') {
                    depthFactorRow.classList.remove('hidden');
                    resistivityFactorRow.classList.remove('hidden');
                    depthFactorValue.textContent = depthFactor.toFixed(2);
                    resistivityFactorValue.textContent = resistivityFactor.toFixed(2);
                } else {
                    depthFactorRow.classList.add('hidden');
                    resistivityFactorRow.classList.add('hidden');
                }
                
                groupingFactorValue.textContent = groupingFactor.toFixed(2);
                totalDeratingFactor.textContent = totalFactor.toFixed(3);
                
                // Final rating
                finalRatingValue.textContent = `${finalRating} A`;
                
                // Render cable visualization
                renderCableVisualization({
                    material,
                    construction,
                    size,
                    installation,
                    arrangement: construction === 'singleCore' ? cableArrangement.value : null,
                    depth: parseInt(depthOfLaying.value),
                    circuits: parseInt(numberOfCircuits.value),
                    spacing: cableSpacing.value,
                    airMethod: airInstallationMethod.value,
                    airArrangement: airArrangement.value,
                    trays: parseInt(numberOfTrays.value)
                });
            }
            
            // Initialize form
            updateConductorSizes();
            updateInstallationFields();
            
            // Add event listeners
            cableConstruction.addEventListener('change', function() {
                updateConductorSizes();
                updateInstallationFields();
                previewCableVisualization();
            });
            
            installationType.addEventListener('change', function() {
                updateInstallationFields();
                previewCableVisualization();
            });
            
            calculateBtn.addEventListener('click', calculateEnhancedRating);
            
            // Add visualization preview for all form changes
            [conductorMaterial, conductorSize, cableArrangement, airInstallationMethod, 
             airArrangement, temperature, depthOfLaying, thermalResistivity, numberOfCircuits, 
             cableSpacing, numberOfTrays].forEach(element => {
                if (element) {
                    element.addEventListener('change', previewCableVisualization);
                }
            });
            
            // Preview cable visualization based on current form values
            function previewCableVisualization() {
                const material = conductorMaterial.value;
                const construction = cableConstruction.value;
                const size = parseInt(conductorSize.value) || 25; // Default to 25 if not selected
                const installation = installationType.value;
                const airMethod = airInstallationMethod.value;
                const airArrangement = airArrangement.value;
                
                renderCableVisualization({
                    material,
                    construction,
                    size,
                    installation,
                    arrangement: construction === 'singleCore' ? cableArrangement.value : null,
                    depth: parseInt(depthOfLaying.value),
                    circuits: parseInt(numberOfCircuits.value),
                    spacing: cableSpacing.value,
                    airMethod,
                    airArrangement,
                    trays: parseInt(numberOfTrays.value)
                });
            }
            
            // Initial preview once the page is fully loaded
            setTimeout(previewCableVisualization, 500);
            
            // Smooth scroll to results after calculation
            calculateBtn.addEventListener('click', function() {
                // No need to scroll now that results are side-by-side
                // The results section is already visible
            });
        });
    </script>
    
    <!-- Add enhanced calculation scripts with proper loading order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="enhanced-calculations.js"></script>
    <!-- Add the fixed calculator script -->
    <script src="fix-calculator.js"></script>
    <!-- Add the PDF generator script -->
    <script src="pdf-generator.js"></script>
    
    <script>
        // Direct calculation function that will ensure correct results
        function directCalculate() {
            console.log("Starting direct calculation...");
            
            try {
                // Check if cableData is defined
                if (typeof cableData === 'undefined') {
                    console.error("cableData is undefined. Make sure cabledata.js is loaded correctly.");
                    alert("Error: Cable data not loaded. Please refresh the page and try again.");
                    return;
                }
                
                // Get form values
                const material = document.getElementById('conductorMaterial').value;
                const construction = document.getElementById('cableConstruction').value;
                const size = parseInt(document.getElementById('conductorSize').value);
                const voltage = document.getElementById('voltageRating').value;
                const installation = document.getElementById('installationType').value;
                const temperature = parseInt(document.getElementById('temperature').value);
                const circuits = parseInt(document.getElementById('numberOfCircuits').value) || 1;
                
                console.log("Form values:", { material, construction, size, voltage, installation, temperature, circuits });
                
                // Get the base rating from cableData
                let baseRating = 0;
                let cableType = '';
                
                if (material === 'copper') {
                    cableType = construction === 'singleCore' ? 'singleCoreCopper' : 'threeCoreCopper';
                } else {
                    cableType = construction === 'singleCore' ? 'singleCoreAluminum' : 'threeCoreAluminum';
                }
                
                console.log("Cable type:", cableType);
                
                if (!cableData[cableType]) {
                    alert("Error: Cable type data not found.");
                    return;
                }
                
                const voltageData = cableData[cableType][voltage];
                if (!voltageData) {
                    alert("Error: Voltage data not found.");
                    return;
                }
                
                let sizeIndex = -1;
                if (construction === 'singleCore') {
                    sizeIndex = cableData.conductorSizes.singleCore.indexOf(size);
                    const arrangement = document.getElementById('cableArrangement').value;
                    
                    if (voltageData[installation] && voltageData[installation][arrangement]) {
                        if (sizeIndex >= 0 && sizeIndex < voltageData[installation][arrangement].length) {
                            baseRating = voltageData[installation][arrangement][sizeIndex];
                        }
                    }
                } else {
                    sizeIndex = cableData.conductorSizes.threeCore.indexOf(size);
                    if (voltageData[installation]) {
                        if (sizeIndex >= 0 && sizeIndex < voltageData[installation].length) {
                            baseRating = voltageData[installation][sizeIndex];
                        }
                    }
                }
                
                if (baseRating === 0) {
                    alert("Error: Could not find base rating for the selected parameters.");
                    return;
                }
                
                console.log("Base rating:", baseRating);
                
                // Calculate derating factors
                let tempFactor = 1.0;
                if (installation === 'inAir') {
                    // Air temperature derating
                    const airTemps = cableData.temperatureFactors.air.temperatures;
                    const airFactors = cableData.temperatureFactors.air.factors;
                    for (let i = 0; i < airTemps.length; i++) {
                        if (airTemps[i] === temperature) {
                            tempFactor = airFactors[i];
                            break;
                        }
                    }
                } else {
                    // Ground temperature derating
                    const groundTemps = cableData.temperatureFactors.ground.temperatures;
                    const groundFactors = cableData.temperatureFactors.ground.factors;
                    for (let i = 0; i < groundTemps.length; i++) {
                        if (groundTemps[i] === temperature) {
                            tempFactor = groundFactors[i];
                            break;
                        }
                    }
                }
                
                // Depth factor (simplified)
                let depthFactor = 1.0;
                if (installation !== 'inAir') {
                    const depth = parseInt(document.getElementById('depthOfLaying').value);
                    if (depth > 900) {
                        depthFactor = 0.95; // Simplified derating for depths > 900mm
                    }
                }
                
                // Soil resistivity factor (simplified)
                let resistivityFactor = 1.0;
                if (installation !== 'inAir') {
                    const resistivity = parseFloat(document.getElementById('thermalResistivity').value);
                    if (resistivity !== 1.5) {
                        resistivityFactor = resistivity > 1.5 ? 0.9 : 1.1; // Simplified
                    }
                }
                
                // Grouping factor (simplified)
                let groupingFactor = 1.0;
                if (circuits > 1) {
                    // Simple grouping factor estimation
                    if (circuits === 2) {
                        groupingFactor = 0.9;
                    } else if (circuits <= 4) {
                        groupingFactor = 0.8;
                    } else if (circuits <= 6) {
                        groupingFactor = 0.75;
                    } else {
                        groupingFactor = 0.7;
                    }
                }
                
                // Calculate total derating factor and final rating
                const totalFactor = tempFactor * depthFactor * resistivityFactor * groupingFactor;
                const finalRating = Math.round(baseRating * totalFactor);
                const finalRatingTotal = finalRating * circuits;
                
                console.log("Derating factors:", { tempFactor, depthFactor, resistivityFactor, groupingFactor, totalFactor });
                console.log("Final rating:", finalRating, "A");
                
                // Display results
                document.getElementById('baseRatingDesc').textContent = 
                    `${material === 'copper' ? 'Copper' : 'Aluminum'} ${construction === 'singleCore' ? 'Single-Core' : 'Three-Core'}, ${voltage}, ${size} mm²`;
                document.getElementById('baseRatingValue').textContent = `${baseRating} A`;
                
                document.getElementById('temperatureFactorValue').textContent = tempFactor.toFixed(2);
                
                const depthFactorRow = document.getElementById('depthFactorRow');
                const resistivityFactorRow = document.getElementById('resistivityFactorRow');
                
                if (installation !== 'inAir') {
                    depthFactorRow.classList.remove('hidden');
                    resistivityFactorRow.classList.remove('hidden');
                    document.getElementById('depthFactorValue').textContent = depthFactor.toFixed(2);
                    document.getElementById('resistivityFactorValue').textContent = resistivityFactor.toFixed(2);
                } else {
                    depthFactorRow.classList.add('hidden');
                    resistivityFactorRow.classList.add('hidden');
                }
                
                document.getElementById('groupingFactorValue').textContent = groupingFactor.toFixed(2);
                document.getElementById('totalDeratingFactor').textContent = totalFactor.toFixed(3);
                
                if (circuits > 1) {
                    document.getElementById('finalRatingValue').textContent = `${finalRating} A × ${circuits} = ${finalRatingTotal} A`;
                } else {
                    document.getElementById('finalRatingValue').textContent = `${finalRating} A`;
                }
                
                // Calculate recommended size
                const requiredCurrent = parseFloat(document.getElementById('requiredCurrent').value) || 0;
                let recommendedSize = size;
                let safetyMargin = 0;
                
                if (requiredCurrent > 0) {
                    const requiredCurrentPerCircuit = requiredCurrent / circuits;
                    const sizesArray = cableData.conductorSizes[construction];
                    
                    // Find smallest cable size that can handle the required current
                    for (let i = 0; i < sizesArray.length; i++) {
                        const testSize = sizesArray[i];
                        let testBaseRating = 0;
                        
                        if (construction === 'singleCore') {
                            const arrangement = document.getElementById('cableArrangement').value;
                            if (voltageData[installation] && voltageData[installation][arrangement] && i < voltageData[installation][arrangement].length) {
                                testBaseRating = voltageData[installation][arrangement][i];
                            }
                        } else {
                            if (voltageData[installation] && i < voltageData[installation].length) {
                                testBaseRating = voltageData[installation][i];
                            }
                        }
                        
                        if (testBaseRating * totalFactor >= requiredCurrentPerCircuit) {
                            recommendedSize = testSize;
                            break;
                        }
                    }
                    
                    safetyMargin = ((finalRatingTotal / requiredCurrent) - 1) * 100;
                }
                
                document.getElementById('recommendedSize').textContent = `${recommendedSize} mm²`;
                document.getElementById('safetyMargin').textContent = safetyMargin > 0 ? 
                    `${safetyMargin.toFixed(1)}%` : "Inadequate";
                
                // Calculate short circuit withstand
                const shortCircuitCurrent = parseFloat(document.getElementById('shortCircuitCurrent').value) || 0;
                const faultDuration = parseFloat(document.getElementById('faultDuration').value) || 1;
                let shortCircuitWithstand = 0;
                let shortCircuitStatus = "N/A";
                
                if (shortCircuitCurrent > 0) {
                    const kValue = material === 'copper' ? 143 : 94;
                    shortCircuitWithstand = Math.round((kValue * size / Math.sqrt(faultDuration)) / 1000); // Convert to kA
                    shortCircuitStatus = shortCircuitWithstand >= shortCircuitCurrent ? "✓ PASS" : "✗ FAIL";
                }
                
                document.getElementById('shortCircuitValue').textContent = `${shortCircuitCurrent} kA`;
                document.getElementById('shortCircuitWithstand').textContent = `${shortCircuitWithstand} kA`;
                document.getElementById('shortCircuitStatus').textContent = shortCircuitStatus;
                
                const shortCircuitStatusEl = document.getElementById('shortCircuitStatus');
                if (shortCircuitStatus.includes("PASS")) {
                    shortCircuitStatusEl.className = 'font-medium text-green-600';
                } else if (shortCircuitStatus.includes("FAIL")) {
                    shortCircuitStatusEl.className = 'font-medium text-red-600';
                }
                
                // Calculate voltage drop
                const cableLength = parseFloat(document.getElementById('cableLength').value) || 100;
                const supplyVoltage = parseFloat(document.getElementById('supplyVoltage').value) || 0;
                const maxVoltageDrop = parseFloat(document.getElementById('maxVoltageDrop').value) || 5;
                let voltageDrop = 0;
                let voltageDropPercent = 0;
                let voltageDropStatus = "N/A";
                
                if (supplyVoltage > 0 && requiredCurrent > 0) {
                    // Simplified resistance values
                    const resistanceValues = {
                        copper: {
                            25: 0.727, 35: 0.524, 50: 0.387, 70: 0.268, 95: 0.193,
                            120: 0.153, 150: 0.124, 185: 0.0991, 240: 0.0754, 300: 0.0601,
                            400: 0.0470, 500: 0.0366, 630: 0.0283, 800: 0.0221, 1000: 0.0176
                        },
                        aluminum: {
                            25: 1.20, 35: 0.868, 50: 0.641, 70: 0.443, 95: 0.320,
                            120: 0.253, 150: 0.206, 185: 0.164, 240: 0.125, 300: 0.100,
                            400: 0.0778, 500: 0.0605, 630: 0.0469, 800: 0.0367, 1000: 0.0291
                        }
                    };
                    
                    const resistancePerKm = resistanceValues[material][recommendedSize] || 0.1;
                    const resistanceTotal = resistancePerKm * cableLength / 1000; // Convert to ohms
                    const currentPerCircuit = requiredCurrent / circuits;
                    
                    if (construction === 'threeCore' || (construction === 'singleCore' && circuits >= 3)) {
                        // Three-phase calculation
                        voltageDrop = Math.sqrt(3) * currentPerCircuit * resistanceTotal;
                    } else {
                        // Single-phase calculation
                        voltageDrop = currentPerCircuit * resistanceTotal;
                    }
                    
                    voltageDropPercent = (voltageDrop / supplyVoltage) * 100;
                    voltageDropStatus = voltageDropPercent <= maxVoltageDrop ? "✓ PASS" : "✗ FAIL";
                }
                
                document.getElementById('voltageDropValue').textContent = `${voltageDrop.toFixed(2)} V`;
                document.getElementById('voltageDropPercent').textContent = `${voltageDropPercent.toFixed(2)}%`;
                document.getElementById('voltageDropStatus').textContent = voltageDropStatus;
                
                const voltageDropStatusEl = document.getElementById('voltageDropStatus');
                if (voltageDropStatus.includes("PASS")) {
                    voltageDropStatusEl.className = 'font-medium text-green-600';
                } else if (voltageDropStatus.includes("FAIL")) {
                    voltageDropStatusEl.className = 'font-medium text-red-600';
                }
                
                // Calculate power loss
                let powerLoss = 0;
                let powerEfficiency = 0;
                
                if (requiredCurrent > 0 && supplyVoltage > 0) {
                    const resistancePerKm = resistanceValues[material][recommendedSize] || 0.1;
                    const resistanceTotal = resistancePerKm * cableLength / 1000; // Convert to ohms
                    const currentPerCircuit = requiredCurrent / circuits;
                    
                    if (construction === 'threeCore' || (construction === 'singleCore' && circuits >= 3)) {
                        // Three-phase power loss
                        powerLoss = 3 * Math.pow(currentPerCircuit, 2) * resistanceTotal / 1000; // Convert to kW
                    } else {
                        // Single-phase power loss
                        powerLoss = Math.pow(currentPerCircuit, 2) * resistanceTotal / 1000; // Convert to kW
                    }
                    
                    const apparentPower = supplyVoltage * requiredCurrent * 
                        (construction === 'threeCore' || (construction === 'singleCore' && circuits >= 3) ? Math.sqrt(3) : 1) / 1000; // kVA
                    
                    powerEfficiency = apparentPower > 0 ? 100 - (powerLoss / apparentPower * 100) : 0;
                }
                
                document.getElementById('powerLossValue').textContent = `${powerLoss.toFixed(2)} kW`;
                document.getElementById('powerEfficiency').textContent = `${powerEfficiency.toFixed(2)}%`;
                
                // Create charts for voltage drop and power loss
                createVoltageDropChart(voltageDropPercent, maxVoltageDrop, voltageDropStatus.includes("PASS"));
                createPowerLossChart(powerEfficiency);
                
                // Make results section visible
                document.getElementById('resultsSection').classList.remove('hidden');
                
                console.log("Calculation completed successfully!");
            } catch (error) {
                console.error("Error in calculation:", error);
                alert("An error occurred during calculation: " + error.message);
            }
        }
        
        // Create voltage drop chart
        function createVoltageDropChart(voltageDropPercent, maxAllowed, isWithinLimits) {
            const ctx = document.getElementById('voltageDropChart');
            if (!ctx) return;
            
            // Clear any existing chart
            if (window.voltageDropChartInstance) {
                window.voltageDropChartInstance.destroy();
            }
            
            // Set colors based on status
            const statusColor = isWithinLimits ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)';
            const statusColorLight = isWithinLimits ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            
            // Create the chart
            window.voltageDropChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Voltage Drop'],
                    datasets: [
                        {
                            label: 'Actual Drop (' + voltageDropPercent.toFixed(2) + '%)',
                            data: [voltageDropPercent],
                            backgroundColor: statusColorLight,
                            borderColor: statusColor,
                            borderWidth: 2,
                            borderRadius: 4,
                            barThickness: 40
                        },
                        {
                            label: 'Maximum Allowed (' + maxAllowed + '%)',
                            data: [maxAllowed],
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            borderRadius: 4,
                            barThickness: 40
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(voltageDropPercent * 1.2, maxAllowed * 1.2),
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Voltage Drop (%)'
                            }
                        }
                    }
                }
            });
        }
        
        // Create power loss chart
        function createPowerLossChart(efficiency) {
            const ctx = document.getElementById('powerLossChart');
            if (!ctx) return;
            
            // Clear any existing chart
            if (window.powerLossChartInstance) {
                window.powerLossChartInstance.destroy();
            }
            
            // Calculate loss percentage
            const lossPercentage = 100 - efficiency;
            
            // Create the chart
            window.powerLossChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Efficiency', 'Power Loss'],
                    datasets: [{
                        data: [efficiency, lossPercentage],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)',  // Green for efficiency
                            'rgba(239, 68, 68, 0.7)'   // Red for power loss
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Add event listener for the PDF download button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                downloadPdfReport();
            });
        });
    </script>
</body>
</html>